<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner</title>
    <meta name="theme-color" content="#111827">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://fav.farm/‚úàÔ∏è">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body
    class="bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#111827] to-black text-gray-100 h-screen flex flex-col overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- LANDING SCREEN -->
    <div id="landing-screen"
        class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 hidden backdrop-blur-sm">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative z-10 flex flex-col items-center w-full max-w-sm">
            <div class="text-7xl mb-6 drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]">‚úàÔ∏è</div>
            <h2
                class="text-4xl font-black mb-10 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 tracking-tight">
                Trip Planner</h2>

            <button id="create-trip-btn"
                class="w-full group relative flex items-center justify-center gap-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-4 rounded-2xl text-lg shadow-lg shadow-blue-900/20 transform transition-all active:scale-95 border border-white/10">
                <span>Start New Trip</span>
            </button>

            <div id="recent-trips-container" class="w-full mt-8 hidden">
                <div class="flex items-center gap-4 mb-4">
                    <div class="h-px bg-gray-800 flex-1"></div>
                    <span class="text-gray-500 text-xs font-bold uppercase tracking-widest">Recent</span>
                    <div class="h-px bg-gray-800 flex-1"></div>
                </div>
                <div id="recent-trips-list" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1"></div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md"></div>
        <div
            class="relative z-10 w-full max-w-xs bg-gray-900/50 p-8 rounded-3xl border border-white/10 shadow-2xl backdrop-blur-xl">
            <h1 class="text-4xl mb-4 text-center">üëã</h1>
            <h2 class="text-xl font-bold mb-6 text-gray-200 text-center">Who are you?</h2>

            <input type="text" id="username-input"
                class="w-full p-4 bg-black/40 border border-white/5 rounded-xl mb-4 text-center text-lg text-white outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                placeholder="Enter your name">

            <button id="login-btn"
                class="w-full bg-white text-black p-4 rounded-xl font-bold hover:bg-gray-200 transition-colors shadow-lg active:scale-95">
                Join Trip
            </button>
            <button onclick="switchTrip()" class="w-full mt-4 text-xs text-gray-500 hover:text-gray-300 py-2">
                ‚Üê Back to Trips
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="flex-1 flex flex-col hidden max-w-lg mx-auto w-full h-full relative z-0">
        <!-- HEADER -->
        <header class="p-4 pt-6 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="copyTripLink()">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center border border-white/5 group-hover:border-blue-500/30 transition-colors">
                    <span class="text-xl">‚úàÔ∏è</span>
                </div>
                <div>
                    <h1 class="font-bold text-base text-gray-100 leading-tight">Trip Planner</h1>
                    <p class="text-[10px] text-green-400 flex items-center gap-1.5 font-medium tracking-wide">
                        <span class="relative flex h-2 w-2">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        Sync Active
                    </p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="switchTrip()"
                    class="bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors border border-white/5">
                    History
                </button>
                <div class="relative">
                    <button id="user-btn" onclick="toggleUserMenu()"
                        class="bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 px-3 py-2 rounded-lg text-xs font-bold border border-blue-500/20 transition-colors flex items-center gap-2">
                        <span id="user-display-name">User</span> ‚ñº
                    </button>
                    <!-- User Dropdown -->
                    <div id="user-menu"
                        class="absolute right-0 top-full mt-2 w-48 bg-gray-900 border border-white/10 rounded-xl shadow-xl overflow-hidden hidden z-50">
                        <div class="p-3 border-b border-white/5">
                            <p class="text-[10px] text-gray-500 uppercase tracking-wider">Logged in as</p>
                            <p id="menu-user-name" class="font-bold text-white truncate"></p>
                        </div>
                        <button onclick="logout()"
                            class="w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 transition-colors flex items-center gap-2">
                            <span class="text-xs">üö™</span> Switch User
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- TABS -->
        <div class="px-4 mb-2">
            <div class="flex bg-black/20 p-1 rounded-xl backdrop-blur-sm border border-white/5">
                <button id="tab-plan"
                    class="flex-1 py-2 text-center text-sm font-bold text-gray-400 rounded-lg transition-all hover:text-white">Plan</button>
                <button id="tab-vote"
                    class="flex-1 py-2 text-center text-sm font-bold text-gray-400 rounded-lg transition-all hover:text-white">Vote</button>
                <button id="tab-pack"
                    class="flex-1 py-2 text-center text-sm font-bold text-gray-400 rounded-lg transition-all hover:text-white">Pack</button>
                <button id="tab-exp"
                    class="flex-1 py-2 text-center text-sm font-bold text-gray-400 rounded-lg transition-all hover:text-white">Cost</button>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="flex-1 overflow-y-auto px-4 pb-4 space-y-4 custom-scrollbar">

            <!-- TAB: PLANNING -->
            <div id="view-plan" class="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
                <!-- DESTINATION HEADER -->
                <div
                    class="relative overflow-hidden bg-gradient-to-br from-blue-900/40 to-gray-900/40 border border-white/10 rounded-2xl p-6 flex justify-between items-center group">
                    <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition-colors"></div>
                    <div class="relative z-10">
                        <h3 class="font-bold text-blue-400 text-[10px] uppercase tracking-[0.2em] mb-1">Destination</h3>
                        <div id="plan-dest-display" class="text-3xl font-black text-white tracking-tight">&lt;Voting&gt;
                        </div>
                    </div>
                    <div id="plan-weather-icon" class="text-5xl filter drop-shadow-lg relative z-10 animate-pulse">
                    </div>
                </div>

                <!-- MEMBERS -->
                <div class="bg-gray-800/30 border border-white/5 rounded-2xl p-4 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3
                            class="font-bold text-gray-500 text-[10px] uppercase tracking-wider flex items-center gap-1">
                            üë• Squad <span id="member-count"
                                class="bg-gray-700 text-gray-300 px-1.5 rounded-md">0</span></h3>
                        <button onclick="copyTripLink()"
                            class="text-[10px] bg-white/5 hover:bg-white/10 text-gray-300 px-2.5 py-1.5 rounded-lg border border-white/5 transition-colors">invite
                            +</button>
                    </div>
                    <div id="member-list" class="flex flex-wrap gap-2"></div>
                </div>

                <!-- CALENDAR -->
                <div class="bg-gray-800/30 border border-white/5 rounded-2xl p-5 backdrop-blur-sm">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-gray-500 text-[10px] uppercase tracking-wider">üìÖ Availability</h3>
                        <div class="flex gap-3 text-[10px] items-center">
                            <span class="flex items-center gap-1 text-gray-400">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div> You
                            </span>
                            <span class="flex items-center gap-1 text-gray-400">
                                <div class="w-2 h-2 rounded-full bg-blue-500"></div> Others
                            </span>
                        </div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1.5 select-none mb-3"></div>
                    <div id="best-dates" class="text-xs text-center font-bold text-purple-300 h-4"></div>
                </div>

            </div>
        </div>

        <!-- TAB: PACKING -->
        <div id="view-pack" class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
            <div class="bg-gray-800/30 border border-white/5 rounded-2xl p-4 backdrop-blur-sm">
                <h3 class="font-bold text-gray-500 text-[10px] uppercase mb-3 tracking-wider">üéí Packing Essentials
                </h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="pack-input" placeholder="Add item..."
                        class="flex-1 px-4 py-2.5 bg-black/20 border border-white/5 rounded-xl text-sm text-white placeholder-gray-600 focus:border-blue-500/50 outline-none transition-colors">
                    <button id="add-pack-btn"
                        class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 flex items-center justify-center rounded-xl font-bold shadow-lg shadow-blue-900/20">+</button>
                </div>
                <div id="packing-list" class="space-y-2 text-sm"></div>
            </div>
        </div>
    </div>

    <!-- TAB: VOTE -->
    <div id="view-vote" class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
        <div class="bg-gray-800/30 border border-white/5 rounded-2xl p-4 backdrop-blur-sm">
            <div class="flex items-center justify-center gap-3 text-sm pb-4 mb-4 border-b border-white/5">
                <span class="text-gray-400 text-xs font-bold uppercase">Trip Length</span>
                <div class="flex items-center bg-black/20 rounded-lg p-1 border border-white/5">
                    <input type="number" id="dur-input"
                        class="w-12 bg-transparent text-center text-white font-bold outline-none" placeholder="?"
                        min="1">
                    <span class="text-gray-500 text-xs pr-2 font-medium">Days</span>
                </div>
            </div>

            <div class="relative mb-6">
                <div class="flex gap-2">
                    <input type="text" id="dest-input"
                        class="flex-1 px-4 py-3 bg-black/20 border border-white/5 rounded-xl text-sm text-white placeholder-gray-600 focus:border-blue-500/50 outline-none transition-colors"
                        placeholder="Search City..." autocomplete="off">
                </div>
                <div id="suggestions-list"
                    class="absolute top-full left-0 right-0 mt-2 bg-gray-900 border border-white/10 rounded-xl shadow-xl z-50 hidden max-h-48 overflow-y-auto">
                </div>
            </div>

            <div id="location-list" class="space-y-3"></div>

            <!-- Weather Widget -->
            <div id="weather-widget" class="hidden mt-6 bg-blue-900/10 border border-blue-500/10 rounded-xl p-4">
                <div class="flex justify-between items-center mb-3 cursor-pointer" onclick="toggleWeather()">
                    <h4 class="text-[10px] font-bold text-blue-300 uppercase tracking-widest">üå§Ô∏è Forecast</h4>
                    <span id="weather-toggle-icon"
                        class="text-[10px] text-blue-400 font-bold bg-blue-900/30 px-2 py-0.5 rounded-full">Expand</span>
                </div>
                <div id="weather-content" class="hidden">
                    <div id="weather-loading" class="text-center text-xs text-blue-400 py-4 animate-pulse">
                        Scanning satellites...</div>
                    <div id="weather-row" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: EXPENSES -->
    <div id="view-exp" class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
        <div class="bg-gray-800/30 border border-white/5 rounded-2xl p-6 backdrop-blur-sm relative overflow-hidden">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-green-500/10 rounded-full blur-xl pointer-events-none">
            </div>
            <div class="flex justify-between items-end mb-6 relative">
                <div>
                    <h3 class="font-bold text-gray-500 text-[10px] uppercase tracking-wider mb-1">Total Spent
                    </h3>
                    <div id="exp-total" class="text-3xl font-mono font-bold text-green-400">‚Ç¨0.00</div>
                </div>
                <div class="text-2xl">üí∏</div>
            </div>

            <div class="space-y-3 mb-2">
                <input type="text" id="exp-desc" placeholder="What involved money?"
                    class="w-full px-4 py-3 bg-black/20 border border-white/5 rounded-xl text-sm text-white placeholder-gray-600 focus:border-green-500/30 outline-none transition-colors">
                <div class="flex gap-2">
                    <input type="number" id="exp-amt" placeholder="0.00"
                        class="w-full px-4 py-3 bg-black/20 border border-white/5 rounded-xl text-sm text-white placeholder-gray-600 focus:border-green-500/30 outline-none">
                    <button id="add-exp-btn"
                        class="bg-green-600 hover:bg-green-500 text-white px-6 rounded-xl font-bold shadow-lg shadow-green-900/20">Add</button>
                </div>
            </div>
        </div>

        <div id="expense-list" class="space-y-2 pb-10"></div>
    </div>

    </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyATX9AewOd8pmUQWkYXYAvb2meH7kGNtbg",
            authDomain: "karayogam-22.firebaseapp.com",
            projectId: "karayogam-22",
            storageBucket: "karayogam-22.firebasestorage.app",
            messagingSenderId: "38360726672",
            appId: "1:38360726672:web:d254e8eed733ddf3c9ac15"
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(JSON.parse(__firebase_config));
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = { id: null, name: null };
        let tripId = null;
        let tripData = { locations: [], duration: '', users: {}, expenses: [], packing: [] };
        let currentTab = 'plan';
        let weatherExpanded = false;
        let unsubscribe = null;
        let userMenuOpen = false;

        // Elements
        const els = {
            landing: document.getElementById('landing-screen'),
            login: document.getElementById('login-screen'),
            app: document.getElementById('app-screen'),

            // App UI
            tabs: {
                plan: document.getElementById('tab-plan'),
                vote: document.getElementById('tab-vote'),
                pack: document.getElementById('tab-pack'),
                exp: document.getElementById('tab-exp')
            },
            views: {
                plan: document.getElementById('view-plan'),
                vote: document.getElementById('view-vote'),
                pack: document.getElementById('view-pack'),
                exp: document.getElementById('view-exp')
            },

            // Components
            userBtn: document.getElementById('user-btn'),
            userMenu: document.getElementById('user-menu'),
            userDisplay: document.getElementById('user-display-name'),
            menuUserName: document.getElementById('menu-user-name'),

            recentTripsCont: document.getElementById('recent-trips-container'),
            recentTripsList: document.getElementById('recent-trips-list'),
            nameIn: document.getElementById('username-input'),

            // Content
            memberList: document.getElementById('member-list'),
            memberCount: document.getElementById('member-count'),
            destDisplay: document.getElementById('plan-dest-display'),
            destIcon: document.getElementById('plan-weather-icon'),
        };

        // --- AUTH & INIT ---
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('token');
            await signInAnonymously(auth);

            if (tripId) attemptAutoJoin(); else showLanding();
        }

        async function attemptAutoJoin() {
            const savedName = localStorage.getItem('trip_user_name');
            if (savedName) joinTrip(savedName); else showLogin();
        }

        function showLanding() {
            els.landing.classList.remove('hidden');
            els.login.classList.add('hidden');
            els.app.classList.add('hidden');
            renderRecentTrips();
        }

        function renderRecentTrips() {
            const recent = JSON.parse(localStorage.getItem('my_trips') || '[]');
            if (recent.length === 0) {
                els.recentTripsCont.classList.add('hidden');
            } else {
                els.recentTripsCont.classList.remove('hidden');
                els.recentTripsList.innerHTML = recent.map(t => `
                    <div onclick="window.location.href='?token=${t.id}'" class="group flex items-center justify-between p-4 bg-black/40 hover:bg-blue-600/20 border border-white/5 hover:border-blue-500/30 rounded-xl cursor-pointer transition-all">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-200 group-hover:text-blue-200">${t.name}</span>
                            <span class="text-[10px] text-gray-500 font-mono">${t.id.slice(0, 6)}</span>
                        </div>
                        <span class="text-gray-500 group-hover:text-blue-400 group-hover:translate-x-1 transition-all">‚ûú</span>
                    </div>
                `).join('');
            }
        }

        function showLogin() {
            els.landing.classList.add('hidden');
            els.login.classList.remove('hidden');
            els.app.classList.add('hidden');
            els.nameIn.value = '';
            els.nameIn.focus();
        }

        async function joinTrip(nameInput) {
            const name = nameInput.trim();
            if (!name) return;

            // Case-insensitive ID generation
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');

            currentUser = { id, name }; // Store exact casing provided by user for display
            localStorage.setItem('trip_user_name', name);

            setupRealtimeListener();

            els.login.classList.add('hidden');
            els.landing.classList.add('hidden');
            els.app.classList.remove('hidden');

            updateUserUI();
            initCalendar();
            setTab('plan');

            addToRecentTrips(tripId, 'Loading...');
        }

        function updateUserUI() {
            els.userDisplay.innerText = currentUser.name;
            els.menuUserName.innerText = currentUser.name;
        }

        // --- DATABASE ADAPTER ---
        const useFirebase = false; // Forced fallback due to permission issues

        const DB = {
            async listen(id, callback) {
                if (useFirebase) {
                    return onSnapshot(doc(db, 'trips', id), (snap) => {
                        callback(snap.exists() ? snap.data() : null);
                    }, err => {
                        console.error("Firebase Error:", err);
                        console.warn("Falling back to LocalStorage...");
                        // If firebase fails, we could try to fallback, but for now let's just use the boolean flag
                    });
                } else {
                    // LocalStorage Simulation
                    const key = `trip_data_${id}`;

                    const load = () => {
                        const raw = localStorage.getItem(key);
                        return raw ? JSON.parse(raw) : null;
                    };

                    // Initial load
                    callback(load());

                    // Poll for changes (since 'storage' event only works across different tabs)
                    const interval = setInterval(() => {
                        const current = JSON.stringify(load());
                        if (current !== this._lastState) {
                            this._lastState = current;
                            callback(load());
                        }
                    }, 1000);

                    this._lastState = JSON.stringify(load());
                    return () => clearInterval(interval);
                }
            },

            async save(id, data) {
                if (useFirebase) {
                    await setDoc(doc(db, 'trips', id), data, { merge: true });
                } else {
                    localStorage.setItem(`trip_data_${id}`, JSON.stringify(data));
                }
            }
        };

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();

            // If new trip and using LS, init empty data if needed
            if (!useFirebase) {
                const key = `trip_data_${tripId}`;
                if (!localStorage.getItem(key)) {
                    localStorage.setItem(key, JSON.stringify({
                        locations: [],
                        duration: '',
                        users: {},
                        expenses: [],
                        packing: []
                    }));
                }
            }

            unsubscribe = DB.listen(tripId, (data) => {
                if (data) {
                    tripData = data;
                    if (!tripData.users) tripData.users = {};

                    // Ensure current user exists in trip
                    if (!tripData.users[currentUser.id]) {
                        console.log("User not in trip, registering...");
                        registerUserInTrip();
                        return; // Wait for next update
                    }

                    if (tripData.users[currentUser.id].name !== currentUser.name) {
                        // Optional: Sync name updates
                    }

                    updateRecentTripName();
                    render();
                } else {
                    // document doesn't exist
                    tripData = { locations: [], duration: '', users: {}, expenses: [], packing: [] };
                    registerUserInTrip();
                }
            });
        }

        function registerUserInTrip() {
            if (!tripData.users) tripData.users = {};
            tripData.users[currentUser.id] = { name: currentUser.name, dates: [] };
            sync();
        }

        function sync() {
            DB.save(tripId, tripData);
        }

        function addToRecentTrips(id, name) {
            let recent = JSON.parse(localStorage.getItem('my_trips') || '[]');
            recent = recent.filter(t => t.id !== id);
            recent.unshift({ id, name });
            if (recent.length > 5) recent.pop();
            localStorage.setItem('my_trips', JSON.stringify(recent));
        }

        function updateRecentTripName() {
            const best = getBestLocation();
            const name = best ? `Trip to ${best.name}` : `Trip ${tripId.slice(0, 4)}`;
            addToRecentTrips(tripId, name);
        }

        function getTripDates() {
            let userDates = [];
            Object.values(tripData.users).forEach(u => {
                if (u.dates) userDates = userDates.concat(u.dates);
            });
            if (userDates.length === 0) return null;
            userDates.sort();
            return { min: userDates[0], max: userDates[userDates.length - 1] };
        }

        async function fetchWeather(lat, lon, start, end) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&start_date=${start}&end_date=${end}`;
                const res = await fetch(url);
                return await res.json();
            } catch (e) {
                console.error("Weather fetch failed", e);
                return null;
            }
        }

        function wCodeToIcon(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return '‚ùÑÔ∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code <= 86) return '‚ùÑÔ∏è';
            if (code <= 99) return '‚õàÔ∏è';
            return '‚ùì';
        }

        function getBestLocation() {
            if (!tripData.locations || tripData.locations.length === 0) return null;
            return [...tripData.locations].sort((a, b) => b.votes.length - a.votes.length)[0];
        }

        // --- TABS & UI ---
        function setTab(tab) {
            currentTab = tab;
            // Reset
            Object.values(els.tabs).forEach(t => t.className = "flex-1 py-2 text-center text-sm font-bold text-gray-500 rounded-lg transition-all hover:text-gray-300 cursor-pointer");
            Object.values(els.views).forEach(v => v.classList.add('hidden'));

            // Active
            els.tabs[tab].className = "flex-1 py-2 text-center text-sm font-bold text-white bg-gray-700/50 shadow-inner rounded-lg transition-all cursor-default";
            els.views[tab].classList.remove('hidden');
            render();
        }

        function render() {
            if (!tripData) return;
            const users = Object.values(tripData.users);
            els.memberCount.innerText = users.length;
            els.memberList.innerHTML = users.map(u => `
                <div class="px-2.5 py-1 bg-black/20 rounded-lg text-xs text-gray-300 border border-white/5 flex items-center gap-1.5 hover:bg-white/5 transition-colors cursor-default">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    <span class="font-medium">${u.name}</span>
                </div>
            `).join('');

            const topLoc = getBestLocation();
            if (currentTab === 'plan') {
                if (topLoc && topLoc.votes.length > 0) {
                    els.destDisplay.innerText = topLoc.name;
                    els.destDisplay.className = "text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300";
                    els.destIcon.innerText = 'üå§Ô∏è';
                    els.destIcon.classList.remove('hidden');
                } else {
                    els.destDisplay.innerText = "Vote Pending";
                    els.destDisplay.className = "text-xl font-bold text-gray-600 uppercase tracking-widest";
                    els.destIcon.classList.add('hidden');
                }
                renderCalendar();
            }

            if (currentTab === 'pack') {
                document.getElementById('packing-list').innerHTML = (tripData.packing || []).map(item => `
                    <div class="group flex items-center p-3.5 bg-black/20 rounded-xl border border-white/5 hover:border-blue-500/30 cursor-pointer transition-all active:scale-[0.99]" 
                         onclick="window.togglePackItem(${item.id})">
                        <div class="w-5 h-5 rounded border ${item.checked ? 'bg-blue-500 border-blue-500' : 'border-gray-500'} flex items-center justify-center mr-3 transition-colors">
                            ${item.checked ? '<div class="text-[10px] text-white font-bold">‚úì</div>' : ''}
                        </div>
                        <span class="${item.checked ? 'text-gray-500 line-through' : 'text-gray-200'} font-medium select-none">${item.text}</span>
                    </div>
                `).join('');
            }

            if (currentTab === 'vote') {
                if (document.activeElement !== document.getElementById('dur-input'))
                    document.getElementById('dur-input').value = tripData.duration || '';

                const locs = [...(tripData.locations || [])].sort((a, b) => b.votes.length - a.votes.length);
                const dates = getTripDates();

                const locHtmlPromises = locs.map(async loc => {
                    const hasVoted = loc.votes.includes(currentUser.id);
                    let weatherHtml = '';

                    if (dates && loc.coords) {
                        // Check cache or fetch
                        // Simple in-memory cache for demo to avoid spamming API on re-renders
                        if (!loc._weather && !loc._fetching) {
                            loc._fetching = true;
                            fetchWeather(loc.coords.lat, loc.coords.lon, dates.min, dates.max).then(w => {
                                loc._weather = w;
                                loc._fetching = false;
                                render(); // Re-render once data is here
                            });
                        }

                        if (loc._weather && loc._weather.daily) {
                            const d = loc._weather.daily;
                            weatherHtml = `<div class="mt-3 flex gap-2 overflow-x-auto pb-1 scrollbar-hide border-t border-white/5 pt-2">`;
                            for (let i = 0; i < d.time.length; i++) {
                                const day = new Date(d.time[i]).toLocaleDateString('en-US', { weekday: 'short' });
                                weatherHtml += `
                                    <div class="flex flex-col items-center min-w-[3rem] p-1 bg-white/5 rounded-lg border border-white/5">
                                        <span class="text-[9px] text-gray-400 uppercase">${day}</span>
                                        <span class="text-base my-0.5">${wCodeToIcon(d.weather_code[i])}</span>
                                        <span class="text-[9px] font-bold text-gray-300">${Math.round(d.temperature_2m_max[i])}¬∞</span>
                                        <span class="text-[9px] text-gray-500">${Math.round(d.temperature_2m_min[i])}¬∞</span>
                                    </div>
                                `;
                            }
                            weatherHtml += `</div>`;
                        }
                    }

                    return `
                    <div class="relative overflow-hidden flex flex-col p-4 bg-black/20 rounded-2xl border ${hasVoted ? 'border-blue-500/50 shadow-[0_0_15px_-3px_rgba(59,130,246,0.3)]' : 'border-white/5'} transition-all group">
                        <div class="flex justify-between items-center w-full">
                            <div class="relative flex-1">
                                <div class="font-bold text-base text-gray-100 mb-0.5">${loc.name}</div>
                                <div class="flex items-center gap-1">
                                    <span class="bg-gray-800 text-gray-400 text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider">${loc.votes.length} Votes</span>
                                    ${hasVoted ? '<span class="text-[9px] text-blue-400 font-bold">YOU</span>' : ''}
                                </div>
                            </div>
                            <button onclick="window.toggleVote(${loc.id})" 
                                class="relative z-10 w-10 h-10 rounded-xl flex items-center justify-center transition-all ${hasVoted ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-white/5 text-gray-500 hover:bg-white/10 hover:text-white'}">
                                ${hasVoted ? '‚úì' : '+'}
                            </button>
                        </div>
                        ${weatherHtml}
                    </div>`;
                });

                Promise.all(locHtmlPromises).then(htmls => {
                    // Dirty hack: since render is synchronous but we need async for weather... 
                    // Actually, we shouldn't await inside map for render. Use state.
                    // Let's rely on the fact that the first pass triggers fetch, and then re-renders.
                    // Construction of HTML needs to be synchronous here to avoid flickering or complicated async UI logic in this simple app.

                    // Revised approach: Build HTML synchronously. If data missing, show loader or nothing.
                    const finalHtml = locs.map(loc => {
                        const hasVoted = loc.votes.includes(currentUser.id);
                        let weatherHtml = '';

                        if (!dates) {
                            weatherHtml = `<div class="mt-2 text-[9px] text-gray-500 italic flex items-center gap-1"><span class="grayscale">üìÖ</span> Select dates in Planning to see forecast</div>`;
                        } else if (loc.coords) {
                            if (!loc._weather && !loc._fetching) {
                                loc._fetching = true;
                                fetchWeather(loc.coords.lat, loc.coords.lon, dates.min, dates.max).then(w => {
                                    loc._weather = w;
                                    loc._fetching = false;
                                    // render();  // Don't re-call render loop here to avoid flashing, state update will trigger next pipe
                                    // Use a simpler approach: update just this element? No, too complex. 
                                    // Re-trigger render is fine as long as we don't fetch indefinitely.
                                    if (currentTab === 'vote') render();
                                });
                                weatherHtml = `<div class="mt-2 text-[9px] text-gray-500 italic animate-pulse">Loading forecast...</div>`;
                            } else if (loc._weather && loc._weather.daily) {
                                const d = loc._weather.daily;
                                weatherHtml = `<div class="mt-3 flex gap-2 overflow-x-auto pb-1 scrollbar-hide border-t border-white/5 pt-2">`;
                                for (let i = 0; i < d.time.length; i++) {
                                    // simple parser
                                    const dateParts = d.time[i].split('-');
                                    const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                                    const day = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
                                    const dateNum = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                                    weatherHtml += `
                                        <div class="flex flex-col items-center min-w-[4rem] p-1 bg-white/5 rounded-lg border border-white/5">
                                            <span class="text-[9px] text-gray-400 uppercase">${day}</span>
                                            <span class="text-[8px] text-gray-500 mb-0.5">${dateNum}</span>
                                            <span class="text-base my-0.5">${wCodeToIcon(d.weather_code[i])}</span>
                                            <div class="flex gap-1">
                                             <span class="text-[9px] font-bold text-gray-300">${Math.round(d.temperature_2m_max[i])}¬∞</span>
                                             <span class="text-[9px] text-gray-500">${Math.round(d.temperature_2m_min[i])}¬∞</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                weatherHtml += `</div>`;
                            }
                        }

                        return `
                        <div class="relative overflow-hidden flex flex-col p-4 bg-black/20 rounded-2xl border ${hasVoted ? 'border-blue-500/50 shadow-[0_0_15px_-3px_rgba(59,130,246,0.3)]' : 'border-white/5'} transition-all group">
                            <div class="flex justify-between items-center w-full">
                                <div class="relative flex-1">
                                    <div class="font-bold text-base text-gray-100 mb-0.5">${loc.name}</div>
                                    <div class="flex items-center gap-1">
                                        <span class="bg-gray-800 text-gray-400 text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider">${loc.votes.length} Votes</span>
                                        ${hasVoted ? '<span class="text-[9px] text-blue-400 font-bold">YOU</span>' : ''}
                                    </div>
                                </div>
                                <button onclick="window.toggleVote(${loc.id})" 
                                    class="relative z-10 w-10 h-10 rounded-xl flex items-center justify-center transition-all ${hasVoted ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-white/5 text-gray-500 hover:bg-white/10 hover:text-white'}">
                                    ${hasVoted ? '‚úì' : '+'}
                                </button>
                            </div>
                            ${weatherHtml}
                        </div>`;
                    }).join('');
                    document.getElementById('location-list').innerHTML = finalHtml;
                });

                if (locs.length > 0) document.getElementById('weather-widget').classList.remove('hidden');
            }

            if (currentTab === 'exp') {
                const total = (tripData.expenses || []).reduce((sum, e) => sum + parseFloat(e.amt), 0);
                document.getElementById('exp-total').innerText = `‚Ç¨${total.toFixed(2)}`;
                document.getElementById('expense-list').innerHTML = (tripData.expenses || []).slice().reverse().map(e => `
                    <div class="flex justify-between items-center bg-black/20 p-4 rounded-xl border-l-2 border-green-500/50 mb-2">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-200 text-sm">${e.what}</span>
                            <span class="text-[10px] text-gray-500 uppercase tracking-wide mt-0.5">by ${e.who}</span>
                        </div>
                        <div class="font-mono font-bold text-green-400 text-base">‚Ç¨${parseFloat(e.amt).toFixed(2)}</div>
                    </div>
                `).join('');
            }
        }

        // --- ACTIONS ---
        window.switchTrip = () => window.location.href = window.location.pathname;
        window.logout = () => { localStorage.removeItem('trip_user_name'); location.reload(); };
        window.toggleUserMenu = () => {
            userMenuOpen = !userMenuOpen;
            els.userMenu.classList.toggle('hidden', !userMenuOpen);
        };
        // Close menu on outside click
        document.addEventListener('click', (e) => {
            if (userMenuOpen && !els.userBtn.contains(e.target) && !els.userMenu.contains(e.target)) {
                userMenuOpen = false;
                els.userMenu.classList.add('hidden');
            }
        });

        window.copyTripLink = () => {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert("Trip Link Copied!");
            });
        };

        // Listeners for inputs
        document.getElementById('create-trip-btn').onclick = async () => {
            const newId = doc(collection(db, "trips")).id;
            window.history.pushState({}, '', `?token=${newId}`);
            tripId = newId;
            addToRecentTrips(newId, 'New Trip');
            attemptAutoJoin();
        };
        document.getElementById('login-btn').onclick = () => joinTrip(els.nameIn.value);
        els.nameIn.onkeypress = (e) => { if (e.key === 'Enter') joinTrip(els.nameIn.value); };

        Object.keys(els.tabs).forEach(k => els.tabs[k].onclick = () => setTab(k));

        // Improvements: Autocomplete
        let debounceTimer;
        const suggestionBox = document.getElementById('suggestions-list');
        const destInput = document.getElementById('dest-input');

        destInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value;
            if (query.length < 3) {
                suggestionBox.classList.add('hidden');
                return;
            }
            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        suggestionBox.innerHTML = data.slice(0, 5).map(place => `
                            <div class="p-3 hover:bg-white/10 cursor-pointer text-xs border-b border-white/5 last:border-0" 
                                 onclick="selectLocation('${place.display_name.replace(/'/g, "\\'")}', ${place.lat}, ${place.lon})">
                                <div class="font-bold text-gray-200">${place.display_name.split(',')[0]}</div>
                                <div class="text-gray-500 truncate">${place.display_name}</div>
                            </div>
                        `).join('');
                        suggestionBox.classList.remove('hidden');
                    }
                } catch (e) { }
            }, 300);
        });

        // Hide suggestions on outside click
        document.addEventListener('click', (e) => {
            if (!destInput.contains(e.target) && !suggestionBox.contains(e.target)) {
                suggestionBox.classList.add('hidden');
            }
        });

        window.selectLocation = (fullName, lat, lon) => {
            const shortName = fullName.split(',')[0];
            if (!tripData.locations.find(l => l.name === shortName)) {
                tripData.locations.push({
                    id: Date.now(),
                    name: shortName, // Display name
                    fullName: fullName, // Store full for context if needed
                    coords: { lat: parseFloat(lat), lon: parseFloat(lon) },
                    votes: [currentUser.id]
                });
                sync();
            }
            destInput.value = '';
            suggestionBox.classList.add('hidden');
        };

        document.getElementById('dur-input').onchange = (e) => { tripData.duration = e.target.value; sync(); };
        document.getElementById('add-exp-btn').onclick = () => {
            const d = document.getElementById('exp-desc'), a = document.getElementById('exp-amt');
            if (d.value && a.value) {
                tripData.expenses.push({ who: currentUser.name, what: d.value, amt: a.value, id: Date.now() });
                sync(); d.value = ''; a.value = '';
            }
        };
        document.getElementById('add-pack-btn').onclick = () => {
            const p = document.getElementById('pack-input');
            if (p.value.trim()) {
                tripData.packing.push({ id: Date.now(), text: p.value.trim(), checked: false });
                sync(); p.value = '';
            }
        };

        window.toggleVote = (id) => {
            const l = tripData.locations.find(x => x.id === id);
            if (!l) return;
            if (l.votes.includes(currentUser.id)) l.votes = l.votes.filter(v => v !== currentUser.id);
            else l.votes.push(currentUser.id);
            sync();
        };
        window.togglePackItem = (id) => {
            tripData.packing = tripData.packing.map(i => i.id === id ? { ...i, checked: !i.checked } : i);
            sync();
        };

        // Calendar
        function initCalendar() {
            const cal = document.getElementById('calendar-grid'); cal.innerHTML = '';
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
                cal.innerHTML += `<div class="text-center text-[9px] font-bold text-gray-600 pb-1">${d}</div>`;
            });
            const today = new Date();
            for (let i = 0; i < 35; i++) {
                const d = new Date(); d.setDate(today.getDate() + i);
                const ds = d.toISOString().split('T')[0];
                const btn = document.createElement('button');
                btn.className = "day-cell h-8 rounded-lg flex flex-col items-center justify-center text-[10px] bg-black/20 border border-white/5 text-gray-500 transition-all";
                btn.dataset.date = ds;
                btn.innerHTML = `<span class="pointer-events-none">${d.getDate()}</span>`;
                btn.onclick = (e) => {
                    if (!tripData.users[currentUser.id]) {
                        // Safety recovery
                        tripData.users[currentUser.id] = { name: currentUser.name, dates: [] };
                    }
                    const u = tripData.users[currentUser.id];
                    let newDates = [...u.dates];

                    if (e.shiftKey && lastClickedDate) {
                        // Range selection
                        const d1 = new Date(lastClickedDate);
                        const d2 = new Date(ds);
                        const start = d1 < d2 ? d1 : d2;
                        const end = d1 < d2 ? d2 : d1;

                        // Add all dates in range
                        for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
                            const dateStr = dt.toISOString().split('T')[0];
                            if (!newDates.includes(dateStr)) newDates.push(dateStr);
                        }
                    } else {
                        // Toggle single
                        if (newDates.includes(ds)) newDates = newDates.filter(x => x !== ds);
                        else newDates.push(ds);
                    }

                    lastClickedDate = ds;
                    u.dates = newDates;

                    // Also clear weather cache to force refresh with new dates
                    if (tripData.locations) tripData.locations.forEach(l => { l._weather = null; l._fetching = false; });
                    sync();
                };
                cal.appendChild(btn);
            }
        }

        let lastClickedDate = null;

        function renderCalendar() {
            const counts = {}; let max = 0;
            Object.values(tripData.users).forEach(u => u.dates?.forEach(d => { counts[d] = (counts[d] || 0) + 1; max = Math.max(max, counts[d]); }));
            document.querySelectorAll('.day-cell').forEach(c => {
                const d = c.dataset.date;
                const my = tripData.users[currentUser.id]?.dates.includes(d);
                const count = counts[d] || 0;

                // Tooltip logic
                const who = Object.values(tripData.users)
                    .filter(u => u.dates && u.dates.includes(d))
                    .map(u => u.name)
                    .join(', ');
                c.title = who ? `Available: ${who}` : 'No one available';

                let cls = "day-cell h-9 rounded-lg flex flex-col items-center justify-center text-[10px] transition-all border ";
                if (my) cls += "bg-green-600/20 border-green-500/50 text-green-300 ";
                else cls += "bg-black/20 border-white/5 text-gray-500 ";

                if (count > 0) {
                    if (count === max && max > 1) {
                        cls = "day-cell h-9 rounded-lg flex flex-col items-center justify-center text-[10px] transition-all border bg-purple-900/40 border-purple-500 text-yellow-200 font-bold shadow-[0_0_10px_-2px_rgba(168,85,247,0.4)] scale-105 z-10";
                    } else if (!my) {
                        cls += "border-blue-500/30 text-blue-200 ";
                    }
                }
                c.className = cls;
            });
            document.getElementById('best-dates').innerText = max > 1 ? `üî• Best Date: ${max} friends` : "Select dates to match!";
        }

        window.toggleWeather = () => {
            const c = document.getElementById('weather-content');
            c.classList.toggle('hidden');
        };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err));
            });
        }

        init();
    </script>
</body>

</html>