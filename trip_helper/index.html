<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Trip Planner</title>
    <meta name="theme-color" content="#111827">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://fav.farm/‚úàÔ∏è">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="bg-black h-full w-full overflow-hidden"></body>
<div id="app-wrapper"
    class="bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#111827] to-black text-gray-100 h-[100dvh] w-full flex flex-col relative overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- LANDING SCREEN -->
    <div id="landing-screen"
        class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 hidden backdrop-blur-sm">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative z-10 flex flex-col items-center w-full max-w-sm">
            <div class="text-7xl mb-6 drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]">‚úàÔ∏è</div>
            <h2
                class="text-4xl font-black mb-10 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 tracking-tight">
                Trip Planner</h2>

            <div id="welcome-msg"
                class="hidden text-gray-400 text-sm font-medium mb-4 animate-in fade-in slide-in-from-bottom-1"></div>

            <button id="create-trip-btn"
                class="w-full group relative flex items-center justify-center gap-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-4 rounded-2xl text-lg shadow-lg shadow-blue-900/20 transform transition-all active:scale-95 border border-white/10">
                <span>Start New Trip</span>
            </button>

            <div id="recent-trips-container" class="w-full mt-8 hidden">
                <div class="flex items-center gap-4 mb-4">
                    <div class="h-px bg-gray-800 flex-1"></div>
                    <span class="text-gray-500 text-xs font-bold uppercase tracking-widest">Recent</span>
                    <div class="h-px bg-gray-800 flex-1"></div>
                </div>
                <div id="recent-trips-list" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1"></div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md"></div>
        <div
            class="relative z-10 w-full max-w-xs bg-gray-900/50 p-8 rounded-3xl border border-white/10 shadow-2xl backdrop-blur-xl max-h-[85dvh] overflow-y-auto custom-scrollbar">
            <h1 class="text-4xl mb-4 text-center">üëã</h1>
            <h2 class="text-xl font-bold mb-6 text-gray-200 text-center">Who are you?</h2>

            <input type="text" id="username-input"
                class="w-full p-4 bg-black/40 border border-white/5 rounded-xl mb-4 text-center text-lg text-white outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600"
                placeholder="Enter your name">

            <button id="login-btn"
                class="w-full bg-white text-black p-4 rounded-xl font-bold hover:bg-gray-200 transition-colors shadow-lg active:scale-95">
                Join Trip
            </button>
            <button onclick="switchTrip()" class="w-full mt-4 text-xs text-gray-500 hover:text-gray-300 py-2">
                ‚Üê Back to Trips
            </button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="flex-1 flex flex-col hidden max-w-lg mx-auto w-full h-full relative z-0">
        <!-- HEADER -->
        <header class="p-4 pt-6 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="copyTripLink()">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center border border-white/5 group-hover:border-blue-500/30 transition-colors">
                    <span class="text-xl">‚úàÔ∏è</span>
                </div>
                <div class="group/title flex items-center gap-2">
                    <h1 id="header-trip-name" class="font-bold text-base text-gray-100 leading-tight">Trip Planner</h1>
                    <button onclick="editTripName()"
                        class="opacity-0 group-hover/title:opacity-100 transition-opacity text-gray-500 hover:text-white text-xs">‚úé</button>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="switchTrip()"
                    class="bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors border border-white/5">
                    History
                </button>
                <div class="relative">
                    <button id="user-btn" onclick="toggleUserMenu()"
                        class="bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 px-3 py-2 rounded-lg text-xs font-bold border border-blue-500/20 transition-colors flex items-center gap-2">
                        <span id="user-display-name">User</span> ‚ñº
                    </button>
                    <!-- User Dropdown -->
                    <div id="user-menu"
                        class="absolute right-0 top-full mt-2 w-48 bg-gray-900 border border-white/10 rounded-xl shadow-xl overflow-hidden hidden z-50">
                        <div class="p-3 border-b border-white/5">
                            <p class="text-[10px] text-gray-500 uppercase tracking-wider">Logged in as</p>
                            <p id="menu-user-name" class="font-bold text-white truncate"></p>
                        </div>
                        <button onclick="downloadTripData()"
                            class="w-full text-left px-4 py-3 text-sm text-blue-300 hover:bg-blue-500/10 transition-colors flex items-center gap-2 border-b border-white/5">
                            <span class="text-xs">üíæ</span> Download Data
                        </button>
                        <button onclick="logout()"
                            class="w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 transition-colors flex items-center gap-2">
                            <span class="text-xs">üö™</span> Switch User
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- TABS -->
        <div class="px-4 mb-2">
            <div class="flex bg-black/20 p-1 rounded-xl backdrop-blur-sm border border-white/5">
                <button id="tab-plan"
                    class="flex-1 py-2 text-center text-sm font-bold text-gray-400 rounded-lg transition-all hover:text-white">Plan</button>
                <button id="tab-vote"
                    class="flex-1 py-2 text-center text-sm font-bold text-gray-400 rounded-lg transition-all hover:text-white">Vote</button>
                <button id="tab-itin"
                    class="flex-1 py-2 text-center text-sm font-bold text-gray-400 rounded-lg transition-all hover:text-white">Itinerary</button>
                <button id="tab-pack"
                    class="flex-1 py-2 text-center text-sm font-bold text-gray-400 rounded-lg transition-all hover:text-white">Checklist</button>
                <button id="tab-exp"
                    class="flex-1 py-2 text-center text-sm font-bold text-gray-400 rounded-lg transition-all hover:text-white">Cost</button>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="flex-1 overflow-y-auto overflow-x-hidden px-4 pb-32 space-y-4 custom-scrollbar">

            <!-- TAB: PLANNING -->
            <div id="view-plan"
                class="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300 overflow-x-hidden">
                <!-- DESTINATION HEADER -->
                <div
                    class="relative overflow-hidden bg-gradient-to-br from-blue-900/40 to-gray-900/40 border border-white/10 rounded-2xl p-6 flex justify-between items-center group">
                    <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition-colors"></div>
                    <div class="relative z-10">
                        <h3 class="font-bold text-blue-400 text-[10px] uppercase tracking-[0.2em] mb-1">Destination</h3>
                        <div id="plan-dest-display" class="text-3xl font-black text-white tracking-tight">&lt;Voting&gt;
                        </div>
                    </div>
                    <div id="plan-weather-icon" class="text-5xl filter drop-shadow-lg relative z-10 animate-pulse">
                    </div>
                </div>

                <!-- MEMBERS -->
                <div class="bg-gray-800/30 border border-white/5 rounded-2xl p-4 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3
                            class="font-bold text-gray-500 text-[10px] uppercase tracking-wider flex items-center gap-1">
                            üë• Squad <span id="member-count"
                                class="bg-gray-700 text-gray-300 px-1.5 rounded-md">0</span></h3>
                        <button onclick="copyTripLink()"
                            class="text-[10px] bg-white/5 hover:bg-white/10 text-gray-300 px-2.5 py-1.5 rounded-lg border border-white/5 transition-colors">invite
                            +</button>
                    </div>
                    <div id="member-list" class="flex flex-wrap gap-2"></div>
                </div>

                <!-- CALENDAR -->
                <div class="bg-gray-800/30 border border-white/5 rounded-2xl p-5 backdrop-blur-sm">
                    <div class="flex justify-between items-end mb-4">
                        <div class="flex flex-col">
                            <h3 class="font-bold text-gray-500 text-[10px] uppercase tracking-wider">üìÖ Availability
                            </h3>
                            <div id="calendar-header" class="text-sm font-bold text-blue-200 mt-1"></div>
                        </div>
                        <div class="flex gap-3 text-[10px] items-center">
                            <span class="flex items-center gap-1 text-gray-400">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div> You
                            </span>
                            <span class="flex items-center gap-1 text-gray-400">
                                <div class="w-2 h-2 rounded-full bg-blue-500"></div> Others
                            </span>
                            <span class="flex items-center gap-1 text-gray-400">
                                <div
                                    class="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.6)] animate-pulse">
                                </div> Best
                            </span>
                        </div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1.5 select-none mb-3"></div>
                    <div id="best-dates" class="text-xs text-center font-bold text-purple-300 h-4"></div>
                </div>

            </div>

            <!-- TAB: ITINERARY -->
            <div id="view-itin"
                class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300 overflow-x-hidden">

                <div id="itin-empty-state"
                    class="hidden flex flex-col items-center justify-center p-8 text-center bg-gray-800/30 border border-white/5 rounded-2xl backdrop-blur-sm">
                    <div class="text-4xl mb-4 grayscale opacity-50">üìÖ</div>
                    <h3 class="text-lg font-bold text-gray-200 mb-2">No Itinerary Yet</h3>
                    <p class="text-sm text-gray-400 mb-6">Voting finished? Lock in the best dates to start planning the
                        details!</p>
                    <button onclick="createItineraryFromBest()"
                        class="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-amber-900/20 active:scale-95 transition-all">
                        ‚ú® Generate Itinerary
                    </button>
                </div>

                <div id="itin-content" class="space-y-4"></div>

                <!-- Add Event Modal -->
                <div id="itin-modal"
                    class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                    <div
                        class="bg-gray-900 border border-white/10 rounded-2xl p-6 w-full max-w-sm shadow-2xl relative max-h-[85dvh] overflow-y-auto custom-scrollbar">
                        <h3 id="itin-modal-title" class="text-lg font-bold text-white mb-4">Add Event</h3>
                        <input type="hidden" id="itin-modal-id">
                        <input type="hidden" id="itin-modal-date">

                        <label class="block text-xs uppercase text-gray-500 font-bold mb-1">Activity</label>
                        <input type="text" id="itin-title-input"
                            class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white mb-4 focus:border-amber-500/50 outline-none"
                            placeholder="e.g. Dinner at Mario's">

                        <div class="flex gap-3 mb-4">
                            <div class="flex-1">
                                <label class="block text-xs uppercase text-gray-500 font-bold mb-1">Time</label>
                                <input type="time" id="itin-time-input"
                                    class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-amber-500/50 outline-none">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs uppercase text-gray-500 font-bold mb-1">Cost (Est)</label>
                                <input type="number" id="itin-cost-input"
                                    class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-amber-500/50 outline-none"
                                    placeholder="‚Ç¨">
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="closeItinModal()"
                                class="flex-1 bg-white/5 hover:bg-white/10 text-gray-400 py-3 rounded-xl font-bold transition-colors">Cancel</button>
                            <button onclick="saveItinEvent()"
                                class="flex-1 bg-amber-600 hover:bg-amber-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-amber-900/20">Save</button>
                        </div>
                        <button id="itin-delete-btn" onclick="deleteItinEvent()"
                            class="mt-2 w-full text-xs text-red-400 py-2 hover:text-red-300 hidden">Delete
                            Event</button>
                    </div>
                </div>

            </div>

            <!-- TAB: PACKING -->
            <div id="view-pack"
                class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300 overflow-x-hidden">
                    <div class="bg-gray-800/30 border border-white/5 rounded-2xl p-4 backdrop-blur-sm">
                        <h3 class="font-bold text-gray-500 text-[10px] uppercase mb-3 tracking-wider">‚úÖ Trip Checklist
                        </h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="pack-input" placeholder="Add item..."
                                class="flex-1 px-4 py-2.5 bg-black/20 border border-white/5 rounded-xl text-base md:text-sm text-white placeholder-gray-600 focus:border-blue-500/50 outline-none transition-colors">
                            <button id="add-pack-btn"
                                class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 flex items-center justify-center rounded-xl font-bold shadow-lg shadow-blue-900/20">+</button>
                        </div>
                        <div id="packing-list" class="space-y-2 text-sm"></div>
                </div>
            </div>

            <!-- TAB: VOTE -->
            <div id="view-vote"
                class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300 overflow-x-hidden">
                    <div class="bg-gray-800/30 border border-white/5 rounded-2xl p-4 backdrop-blur-sm overflow-hidden">
                        <div class="flex items-center justify-center gap-3 text-sm pb-4 mb-4 border-b border-white/5">
                            <span class="text-gray-400 text-xs font-bold uppercase">Trip Length</span>
                            <div class="flex items-center bg-black/20 rounded-lg p-1 border border-white/5">
                                <input type="number" id="dur-input"
                                    class="w-12 bg-transparent text-center text-white font-bold outline-none"
                                    placeholder="?" min="1">
                                <span class="text-gray-500 text-xs pr-2 font-medium">Days</span>
                            </div>
                        </div>

                        <div class="relative mb-6 w-full max-w-full z-30">
                            <div class="flex gap-2">
                                <input type="text" id="dest-input"
                                    class="flex-1 w-full px-4 py-3 bg-black/20 border border-white/5 rounded-xl text-base md:text-sm text-white placeholder-gray-600 focus:border-blue-500/50 outline-none transition-colors"
                                    placeholder="Search City..." autocomplete="off">
                            </div>
                            <div id="suggestions-list"
                                class="absolute top-full left-0 right-0 mt-2 bg-gray-900 border border-white/10 rounded-xl shadow-xl hidden max-h-48 overflow-y-auto w-full overflow-hidden">
                            </div>
                        </div>

                        <div id="location-list" class="space-y-3"></div>

                        <!-- Weather Widget -->
                        <div id="weather-widget"
                            class="hidden mt-6 bg-blue-900/10 border border-blue-500/10 rounded-xl p-4">
                            <div class="flex justify-between items-center mb-3 cursor-pointer"
                                onclick="toggleWeather()">
                                <h4 class="text-[10px] font-bold text-blue-300 uppercase tracking-widest">üå§Ô∏è Forecast
                                </h4>
                                <span id="weather-toggle-icon"
                                    class="text-[10px] text-blue-400 font-bold bg-blue-900/30 px-2 py-0.5 rounded-full">Expand</span>
                            </div>
                            <div id="weather-content" class="hidden">
                                <div id="weather-loading" class="text-center text-xs text-blue-400 py-4 animate-pulse">
                                    Scanning satellites...</div>
                                <div id="weather-row" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide"></div>
                            </div>
                    </div>
                </div>
            </div>

            <!-- TAB: EXPENSES -->
            <div id="view-exp"
                class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300 overflow-x-hidden">
                    <div
                        class="bg-gray-800/30 border border-white/5 rounded-2xl p-6 backdrop-blur-sm relative overflow-hidden">
                        <div
                            class="absolute -right-6 -top-6 w-24 h-24 bg-green-500/10 rounded-full blur-xl pointer-events-none">
                        </div>

                        <!-- Graph Section -->
                        <div id="cost-graph-container" class="mb-6 hidden">
                            <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Spending
                                Breakdown</h4>
                            <div id="cost-graph-bars" class="space-y-2"></div>
                        </div>

                        <div class="flex justify-between items-end mb-6 relative">
                            <div>
                                <h3 class="font-bold text-gray-500 text-[10px] uppercase tracking-wider mb-1">Total
                                    Spent
                                </h3>
                                <div id="exp-total" class="text-3xl font-mono font-bold text-green-400">‚Ç¨0.00</div>
                            </div>
                            <div class="text-2xl">üí∏</div>
                        </div>

                        <div class="space-y-3 mb-2">
                            <input type="text" id="exp-desc" placeholder="What involved money?"
                                class="w-full px-4 py-3 bg-black/20 border border-white/5 rounded-xl text-sm text-white placeholder-gray-600 focus:border-green-500/30 outline-none transition-colors">
                            <div class="flex gap-2">
                                <input type="number" id="exp-amt" placeholder="0.00"
                                    class="w-full px-4 py-3 bg-black/20 border border-white/5 rounded-xl text-sm text-white placeholder-gray-600 focus:border-green-500/30 outline-none">
                                <button id="add-exp-btn"
                                    class="bg-green-600 hover:bg-green-500 text-white px-6 rounded-xl font-bold shadow-lg shadow-green-900/20">Add</button>
                            </div>
                        </div>
                    </div>

                    <div id="expense-list" class="space-y-2 pb-10"></div>
                </div>

            </div>
        </div>

        <!-- Add Event Modal (outside scrollable content) -->
    </div> <!-- End app-wrapper -->

    <!-- Firebase Configuration -->
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyATX9AewOd8pmUQWkYXYAvb2meH7kGNtbg",
            authDomain: "karayogam-22.firebaseapp.com",
            projectId: "karayogam-22",
            storageBucket: "karayogam-22.firebasestorage.app",
            messagingSenderId: "38360726672",
            appId: "1:38360726672:web:d254e8eed733ddf3c9ac15"
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(JSON.parse(__firebase_config));
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = { id: null, name: null };
        let tripId = null;
        let tripData = { locations: [], duration: '', users: {}, expenses: [], packing: [], itinerary: {} };

        let currentTab = 'plan';
        let weatherExpanded = false;
        let unsubscribe = null;
        let userMenuOpen = false;

        // Elements
        const els = {
            landing: document.getElementById('landing-screen'),
            login: document.getElementById('login-screen'),
            app: document.getElementById('app-screen'),

            // App UI
            tabs: {
                plan: document.getElementById('tab-plan'),
                vote: document.getElementById('tab-vote'),
                itin: document.getElementById('tab-itin'),
                pack: document.getElementById('tab-pack'),
                exp: document.getElementById('tab-exp')
            },
            views: {
                plan: document.getElementById('view-plan'),
                vote: document.getElementById('view-vote'),
                itin: document.getElementById('view-itin'),
                pack: document.getElementById('view-pack'),
                exp: document.getElementById('view-exp')

            },

            // Components
            userBtn: document.getElementById('user-btn'),
            userMenu: document.getElementById('user-menu'),
            userDisplay: document.getElementById('user-display-name'),
            menuUserName: document.getElementById('menu-user-name'),

            recentTripsCont: document.getElementById('recent-trips-container'),
            recentTripsList: document.getElementById('recent-trips-list'),
            nameIn: document.getElementById('username-input'),

            // Content
            memberList: document.getElementById('member-list'),
            memberCount: document.getElementById('member-count'),
            destDisplay: document.getElementById('plan-dest-display'),
            destIcon: document.getElementById('plan-weather-icon'),
        };

        // --- AUTH & INIT ---
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('token');
            await signInAnonymously(auth);

            if (tripId) attemptAutoJoin(); else showLanding();
        }

        async function attemptAutoJoin() {
            const savedName = localStorage.getItem('trip_user_name');
            if (savedName) joinTrip(savedName); else showLogin();
        }

        function showLanding() {
            els.landing.classList.remove('hidden');
            els.login.classList.add('hidden');
            els.app.classList.add('hidden');
            renderRecentTrips();
        }

        function renderRecentTrips() {
            const userName = localStorage.getItem('trip_user_name');
            if (userName) {
                document.getElementById('welcome-msg').innerText = `Welcome back, ${userName}!`;
                document.getElementById('welcome-msg').classList.remove('hidden');
            }

            const recent = JSON.parse(localStorage.getItem('my_trips') || '[]');
            if (recent.length === 0) {
                els.recentTripsCont.classList.add('hidden');
            } else {
                els.recentTripsCont.classList.remove('hidden');
                els.recentTripsList.innerHTML = recent.map(t => `
                    <div onclick="window.location.href='?token=${t.id}'" class="group flex items-center justify-between p-4 bg-gray-800/40 hover:bg-blue-600/10 border border-white/5 hover:border-blue-500/30 rounded-xl cursor-pointer transition-all active:scale-[0.98]">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center text-xs">‚úàÔ∏è</div>
                            <div class="flex flex-col">
                                <span class="font-bold text-gray-200 text-sm group-hover:text-blue-200">${t.name}</span>
                                <span class="text-[10px] text-gray-500 font-mono">ID: ${t.id.slice(0, 6)}...</span>
                            </div>
                        </div>
                        <span class="text-gray-600 group-hover:text-blue-400 group-hover:translate-x-1 transition-all text-sm">‚ûú</span>
                    </div>
                `).join('');
            }
        }

        function showLogin() {
            els.landing.classList.add('hidden');
            els.login.classList.remove('hidden');
            els.app.classList.add('hidden');
            els.nameIn.value = '';
            els.nameIn.focus();
        }

        async function joinTrip(nameInput) {
            const name = nameInput.trim();
            if (!name) return;

            // Case-insensitive ID generation
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');

            currentUser = { id, name }; // Store exact casing provided by user for display
            localStorage.setItem('trip_user_name', name);

            setupRealtimeListener();

            els.login.classList.add('hidden');
            els.landing.classList.add('hidden');
            els.app.classList.remove('hidden');

            updateUserUI();
            initCalendar();
            setTab('plan');

            addToRecentTrips(tripId, 'Loading...');
        }

        function updateUserUI() {
            els.userDisplay.innerText = currentUser.name;
            els.menuUserName.innerText = currentUser.name;
        }

        // --- DATABASE ADAPTER ---
        const useFirebase = false; // Forced fallback due to permission issues

        const DB = {
            async listen(id, callback) {
                if (useFirebase) {
                    return onSnapshot(doc(db, 'trips', id), (snap) => {
                        callback(snap.exists() ? snap.data() : null);
                    }, err => {
                        console.error("Firebase Error:", err);
                        console.warn("Falling back to LocalStorage...");
                        // If firebase fails, we could try to fallback, but for now let's just use the boolean flag
                    });
                } else {
                    // LocalStorage Simulation
                    const key = `trip_data_${id}`;

                    const load = () => {
                        const raw = localStorage.getItem(key);
                        return raw ? JSON.parse(raw) : null;
                    };

                    // Initial load
                    callback(load());

                    // Poll for changes (since 'storage' event only works across different tabs)
                    const interval = setInterval(() => {
                        const current = JSON.stringify(load());
                        if (current !== this._lastState) {
                            this._lastState = current;
                            callback(load());
                        }
                    }, 1000);

                    this._lastState = JSON.stringify(load());
                    return () => clearInterval(interval);
                }
            },

            async save(id, data) {
                if (useFirebase) {
                    await setDoc(doc(db, 'trips', id), data, { merge: true });
                } else {
                    localStorage.setItem(`trip_data_${id}`, JSON.stringify(data));
                }
            }
        };

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();

            // If new trip and using LS, init empty data if needed
            if (!useFirebase) {
                const key = `trip_data_${tripId}`;
                if (!localStorage.getItem(key)) {
                    localStorage.setItem(key, JSON.stringify({
                        locations: [],
                        duration: '',
                        users: {},
                        expenses: [],
                        packing: [
                            { id: 1, text: "Book Travel Tickets", checked: false },
                            { id: 2, text: "Book Hotels", checked: false }
                        ],
                        itinerary: {}
                    }));
                }
            }

            unsubscribe = DB.listen(tripId, (data) => {
                if (data) {
                    tripData = data;
                    if (!tripData.users) tripData.users = {};

                    // Ensure current user exists in trip
                    if (!tripData.users[currentUser.id]) {
                        console.log("User not in trip, registering...");
                        registerUserInTrip();
                        return; // Wait for next update
                    }

                    if (tripData.users[currentUser.id].name !== currentUser.name) {
                        // Optional: Sync name updates
                    }

                    updateRecentTripName();
                    render();
                } else {
                    // document doesn't exist
                    tripData = {
                        locations: [], duration: '', users: {}, expenses: [], packing: [
                            { id: 1, text: "Book Travel Tickets", checked: false },
                            { id: 2, text: "Book Hotels", checked: false }
                        ],
                        itinerary: {}
                    };
                    registerUserInTrip();
                }
            });
        }

        function registerUserInTrip() {
            if (!tripData.users) tripData.users = {};
            tripData.users[currentUser.id] = { name: currentUser.name, dates: [] };
            sync();
        }

        function sync() {
            DB.save(tripId, tripData);
        }

        function addToRecentTrips(id, name) {
            let recent = JSON.parse(localStorage.getItem('my_trips') || '[]');
            recent = recent.filter(t => t.id !== id);
            recent.unshift({ id, name });
            if (recent.length > 5) recent.pop();
            localStorage.setItem('my_trips', JSON.stringify(recent));
        }

        function updateRecentTripName() {
            if (tripData.name) {
                addToRecentTrips(tripId, tripData.name);
                return;
            }
            const best = getBestLocation();
            const name = best ? `Trip to ${best.name}` : `Trip ${tripId.slice(0, 4)}`;
            addToRecentTrips(tripId, name);
        }

        function getTripDates() {
            let userDates = [];
            Object.values(tripData.users).forEach(u => {
                if (u.dates) userDates = userDates.concat(u.dates);
            });
            if (userDates.length === 0) return null;
            userDates.sort();
            return { min: userDates[0], max: userDates[userDates.length - 1] };
        }

        async function fetchWeather(lat, lon, start, end) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&start_date=${start}&end_date=${end}`;
                const res = await fetch(url);
                return await res.json();
            } catch (e) {
                console.error("Weather fetch failed", e);
                return null;
            }
        }

        function wCodeToIcon(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return '‚ùÑÔ∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code <= 86) return '‚ùÑÔ∏è';
            if (code <= 99) return '‚õàÔ∏è';
            return '‚ùì';
        }

        function getBestLocation() {
            if (!tripData.locations || tripData.locations.length === 0) return null;
            const sorted = [...tripData.locations].sort((a, b) => b.votes.length - a.votes.length);
            // Check for tie
            if (sorted.length > 1 && sorted[0].votes.length === sorted[1].votes.length && sorted[0].votes.length > 0) {
                return { name: "Voting Tied...", isTie: true, votes: sorted[0].votes };
            }
            return sorted[0];
        }

        // --- ACTIONS ---
        window.togglePackItem = (id) => {
            const item = tripData.packing.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                sync();
            }
        };

        window.deletePackItem = (id) => {
            tripData.packing = tripData.packing.filter(i => i.id !== id);
            sync();
        };

        // --- TABS & UI ---
        function setTab(tab) {
            currentTab = tab;
            // Reset
            Object.values(els.tabs).forEach(t => t.className = "flex-1 py-2 text-center text-sm font-bold text-gray-500 rounded-lg transition-all hover:text-gray-300 cursor-pointer");
            Object.values(els.views).forEach(v => v.classList.add('hidden'));

            // Active
            els.tabs[tab].className = "flex-1 py-2 text-center text-sm font-bold text-white bg-gray-700/50 shadow-inner rounded-lg transition-all cursor-default";
            els.views[tab].classList.remove('hidden');
            render();
        }

        function render() {
            if (!tripData) return;
            const users = Object.values(tripData.users);
            els.memberCount.innerText = users.length;
            els.memberList.innerHTML = users.map(u => `
                <div class="px-2.5 py-1 bg-black/20 rounded-lg text-xs text-gray-300 border border-white/5 flex items-center gap-1.5 hover:bg-white/5 transition-colors cursor-default">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                    <span class="font-medium">${u.name}</span>
                </div>
            `).join('');

            document.getElementById('header-trip-name').innerText = tripData.name || "Trip Planner";


            const topLoc = getBestLocation();
            if (currentTab === 'plan') {
                if (topLoc && topLoc.votes.length > 0) {
                    els.destDisplay.innerText = topLoc.name;
                    if (topLoc.isTie) {
                        els.destDisplay.className = "text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-amber-500";
                        els.destIcon.innerText = '‚öñÔ∏è';
                    } else {
                        els.destDisplay.className = "text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300";
                        els.destIcon.innerText = 'üå§Ô∏è';
                    }
                    els.destIcon.classList.remove('hidden');
                } else {
                    els.destDisplay.innerText = "Vote Pending";
                    els.destDisplay.className = "text-xl font-bold text-gray-600 uppercase tracking-widest";
                    els.destIcon.classList.add('hidden');
                }
                renderCalendar();
            }

            if (currentTab === 'itin') {
                renderItinerary();
            }

            if (currentTab === 'pack') {
                document.getElementById('packing-list').innerHTML = (tripData.packing || []).map(item => `
                    <div class="group flex items-center p-3.5 bg-black/20 rounded-xl border border-white/5 hover:border-blue-500/30 cursor-pointer transition-all active:scale-[0.99]" 
                         onclick="window.togglePackItem(${item.id})">
                        <div class="w-5 h-5 rounded border ${item.checked ? 'bg-blue-500 border-blue-500' : 'border-gray-500'} flex items-center justify-center mr-3 transition-colors">
                            ${item.checked ? '<div class="text-[10px] text-white font-bold">‚úì</div>' : ''}
                        </div>
                        <span class="${item.checked ? 'text-gray-500 line-through' : 'text-gray-200'} font-medium select-none flex-1">${item.text}</span>
                        <button onclick="event.stopPropagation(); window.deletePackItem(${item.id})" class="text-gray-600 hover:text-red-400 p-2 transition-colors">‚úï</button>
                    </div>
                `).join('');
            }

            if (currentTab === 'vote') {
                if (document.activeElement !== document.getElementById('dur-input'))
                    document.getElementById('dur-input').value = tripData.duration || '';

                const locs = [...(tripData.locations || [])].sort((a, b) => b.votes.length - a.votes.length);
                const dates = getTripDates();

                const locHtmlPromises = locs.map(async loc => {
                    const hasVoted = loc.votes.includes(currentUser.id);
                    let weatherHtml = '';

                    if (dates && loc.coords) {
                        // Check cache or fetch
                        // Simple in-memory cache for demo to avoid spamming API on re-renders
                        if (!loc._weather && !loc._fetching) {
                            loc._fetching = true;
                            fetchWeather(loc.coords.lat, loc.coords.lon, dates.min, dates.max).then(w => {
                                loc._weather = w;
                                loc._fetching = false;
                                render(); // Re-render once data is here
                            });
                        }

                        if (loc._weather && loc._weather.daily) {
                            const d = loc._weather.daily;
                            weatherHtml = `<div class="mt-3 flex gap-2 overflow-x-auto pb-1 scrollbar-hide border-t border-white/5 pt-2">`;
                            for (let i = 0; i < d.time.length; i++) {
                                const day = new Date(d.time[i]).toLocaleDateString('en-US', { weekday: 'short' });
                                weatherHtml += `
                                    <div class="flex flex-col items-center min-w-[3rem] p-1 bg-white/5 rounded-lg border border-white/5">
                                        <span class="text-[9px] text-gray-400 uppercase">${day}</span>
                                        <span class="text-base my-0.5">${wCodeToIcon(d.weather_code[i])}</span>
                                        <span class="text-[9px] font-bold text-gray-300">${Math.round(d.temperature_2m_max[i])}¬∞</span>
                                        <span class="text-[9px] text-gray-500">${Math.round(d.temperature_2m_min[i])}¬∞</span>
                                    </div>
                                `;
                            }
                            weatherHtml += `</div>`;
                        }
                    }

                    return `
                    <div class="relative overflow-hidden flex flex-col p-4 bg-black/20 rounded-2xl border ${hasVoted ? 'border-blue-500/50 shadow-[0_0_15px_-3px_rgba(59,130,246,0.3)]' : 'border-white/5'} transition-all group">
                        <div class="flex justify-between items-center w-full">
                            <div class="relative flex-1">
                                <div class="font-bold text-base text-gray-100 mb-0.5">${loc.name}</div>
                                <div class="flex items-center gap-1">
                                    <span class="bg-gray-800 text-gray-400 text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider">${loc.votes.length} Votes</span>
                                    ${hasVoted ? '<span class="text-[9px] text-blue-400 font-bold">YOU</span>' : ''}
                                </div>
                            </div>
                            <button onclick="window.toggleVote(${loc.id})" 
                                class="relative z-10 w-10 h-10 rounded-xl flex items-center justify-center transition-all ${hasVoted ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-white/5 text-gray-500 hover:bg-white/10 hover:text-white'}">
                                ${hasVoted ? '‚úì' : '+'}
                            </button>
                        </div>
                        ${weatherHtml}
                    </div>`;
                });

                Promise.all(locHtmlPromises).then(htmls => {
                    // Dirty hack: since render is synchronous but we need async for weather... 
                    // Actually, we shouldn't await inside map for render. Use state.
                    // Let's rely on the fact that the first pass triggers fetch, and then re-renders.
                    // Construction of HTML needs to be synchronous here to avoid flickering or complicated async UI logic in this simple app.

                    // Revised approach: Build HTML synchronously. If data missing, show loader or nothing.
                    const finalHtml = locs.map(loc => {
                        const hasVoted = loc.votes.includes(currentUser.id);
                        let weatherHtml = '';

                        if (!dates) {
                            weatherHtml = `<div class="mt-2 text-[9px] text-gray-500 italic flex items-center gap-1"><span class="grayscale">üìÖ</span> Select dates in Planning to see forecast</div>`;
                        } else if (loc.coords) {
                            if (!loc._weather && !loc._fetching) {
                                loc._fetching = true;
                                fetchWeather(loc.coords.lat, loc.coords.lon, dates.min, dates.max).then(w => {
                                    loc._weather = w;
                                    loc._fetching = false;
                                    // render();  // Don't re-call render loop here to avoid flashing, state update will trigger next pipe
                                    // Use a simpler approach: update just this element? No, too complex. 
                                    // Re-trigger render is fine as long as we don't fetch indefinitely.
                                    if (currentTab === 'vote') render();
                                });
                                weatherHtml = `<div class="mt-2 text-[9px] text-gray-500 italic animate-pulse">Loading forecast...</div>`;
                            } else if (loc._weather && loc._weather.daily) {
                                const d = loc._weather.daily;
                                weatherHtml = `<div class="mt-3 flex gap-2 overflow-x-auto pb-1 scrollbar-hide border-t border-white/5 pt-2 w-full max-w-full">`;
                                for (let i = 0; i < d.time.length; i++) {
                                    // simple parser
                                    const dateParts = d.time[i].split('-');
                                    const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                                    const day = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
                                    const dateNum = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                                    weatherHtml += `
                                        <div class="flex flex-col items-center min-w-[4rem] p-1 bg-white/5 rounded-lg border border-white/5">
                                            <span class="text-[9px] text-gray-400 uppercase">${day}</span>
                                            <span class="text-[8px] text-gray-500 mb-0.5">${dateNum}</span>
                                            <span class="text-base my-0.5">${wCodeToIcon(d.weather_code[i])}</span>
                                            <div class="flex gap-1">
                                             <span class="text-[9px] font-bold text-gray-300">${Math.round(d.temperature_2m_max[i])}¬∞</span>
                                             <span class="text-[9px] text-gray-500">${Math.round(d.temperature_2m_min[i])}¬∞</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                weatherHtml += `</div>`;
                            }
                        }

                        return `
                        <div class="relative overflow-hidden flex flex-col p-4 bg-black/20 rounded-2xl border ${hasVoted ? 'border-blue-500/50 shadow-[0_0_15px_-3px_rgba(59,130,246,0.3)]' : 'border-white/5'} transition-all group">
                            <div class="flex justify-between items-center w-full">
                                <div class="relative flex-1">
                                    <div class="font-bold text-base text-gray-100 mb-0.5">${loc.name}</div>
                                    <div class="flex items-center gap-1">
                                        <span class="bg-gray-800 text-gray-400 text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider">${loc.votes.length} Votes</span>
                                        ${hasVoted ? '<span class="text-[9px] text-blue-400 font-bold">YOU</span>' : ''}
                                    </div>
                                </div>
                                <button onclick="window.toggleVote(${loc.id})" 
                                    class="relative z-10 w-10 h-10 rounded-xl flex items-center justify-center transition-all ${hasVoted ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-white/5 text-gray-500 hover:bg-white/10 hover:text-white'}">
                                    ${hasVoted ? '‚úì' : '+'}
                                </button>
                            </div>
                            ${weatherHtml}
                        </div>`;
                    }).join('');
                    document.getElementById('location-list').innerHTML = finalHtml;
                });

                if (locs.length > 0) document.getElementById('weather-widget').classList.remove('hidden');
            }

            if (currentTab === 'exp') {
                const expenses = tripData.expenses || [];
                const total = expenses.reduce((sum, e) => sum + parseFloat(e.amt), 0);
                const users = Object.values(tripData.users);
                const userCount = users.length || 1;
                const split = total / userCount;

                // Calculate balances
                const balances = {};
                users.forEach(u => balances[u.name] = 0);

                // Add paid amounts (using name matching for now, simplistic)
                expenses.forEach(e => {
                    if (balances[e.who] !== undefined) balances[e.who] += parseFloat(e.amt);
                    else balances[e.who] = (balances[e.who] || 0) + parseFloat(e.amt); // Handle users not in list gracefully-ish
                });

                document.getElementById('exp-total').innerText = `‚Ç¨${total.toFixed(2)}`;

                // --- COST GRAPH ---
                const spendingByUser = {};
                users.forEach(u => spendingByUser[u.name] = 0);
                expenses.forEach(e => {
                    spendingByUser[e.who] = (spendingByUser[e.who] || 0) + parseFloat(e.amt);
                });

                const sortedSpenders = Object.entries(spendingByUser)
                    .sort(([, a], [, b]) => b - a);

                const maxSpent = sortedSpenders.length > 0 ? sortedSpenders[0][1] : 0;

                if (maxSpent > 0) {
                    document.getElementById('cost-graph-container').classList.remove('hidden');
                    document.getElementById('cost-graph-bars').innerHTML = sortedSpenders.map(([name, amt]) => {
                        const percent = (amt / maxSpent) * 100;
                        const isMax = amt === maxSpent;
                        const isMin = amt === sortedSpenders[sortedSpenders.length - 1][1] && sortedSpenders.length > 1;

                        let colorClass = "bg-gray-600";
                        if (isMax) colorClass = "bg-red-500"; // Big spender
                        else if (isMin) colorClass = "bg-green-500"; // Saver

                        return `
                            <div class="flex items-center gap-2 text-xs">
                                <div class="w-16 truncate text-right text-gray-400 font-medium">${name}</div>
                                <div class="flex-1 bg-black/40 rounded-full h-2 overflow-hidden">
                                    <div class="h-full ${colorClass} rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                                </div>
                                <div class="w-12 text-right font-mono text-gray-300">‚Ç¨${amt.toFixed(0)}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('cost-graph-container').classList.add('hidden');
                }

                // Render Balances
                const balanceHtml = users.map(u => {
                    const paid = balances[u.name] || 0;
                    const diff = paid - split;
                    const isOwed = diff > 0.01;
                    const isOwing = diff < -0.01;
                    const color = isOwed ? 'text-green-400' : (isOwing ? 'text-red-400' : 'text-gray-400');
                    const text = isOwed ? `Gets ‚Ç¨${Math.abs(diff).toFixed(2)}` : (isOwing ? `Owes ‚Ç¨${Math.abs(diff).toFixed(2)}` : 'Settled');

                    return `
                        <div class="flex justify-between items-center text-sm py-1 border-b border-white/5 last:border-0">
                            <span class="text-gray-300">${u.name}</span>
                            <span class="font-mono font-bold ${color}">${text}</span>
                        </div>
                    `;
                }).join('');

                const balanceContainer = `
                    <div class="bg-gray-900/50 rounded-xl p-4 border border-white/5 mb-4">
                        <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2">Balances (Split ${users.length})</h4>
                        <div class="space-y-1">${balanceHtml}</div>
                    </div>
                `;

                const listHtml = expenses.slice().reverse().map(e => `
                    <div class="flex justify-between items-center bg-black/20 p-3 rounded-xl border-l-2 border-green-500/50 mb-2">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-200 text-sm">${e.what}</span>
                            <span class="text-[10px] text-gray-500 uppercase tracking-wide mt-0.5">${e.who} paid</span>
                        </div>
                        <div class="font-mono font-bold text-gray-300 text-sm">‚Ç¨${parseFloat(e.amt).toFixed(2)}</div>
                    </div>
                `).join('');

                document.getElementById('expense-list').innerHTML = balanceContainer + listHtml;
            }
        }

        // --- ACTIONS ---
        window.editTripName = () => {
            const newName = prompt("Enter a name for this trip:", tripData.name || "Trip Planner");
            if (newName && newName.trim()) {
                tripData.name = newName.trim();
                sync();
                render();
                updateRecentTripName();
            }
        };

        window.switchTrip = () => window.location.href = window.location.pathname;
        window.logout = () => { localStorage.removeItem('trip_user_name'); location.reload(); };
        window.toggleUserMenu = () => {
            userMenuOpen = !userMenuOpen;
            els.userMenu.classList.toggle('hidden', !userMenuOpen);
        };
        // Close menu on outside click
        document.addEventListener('click', (e) => {
            if (userMenuOpen && !els.userBtn.contains(e.target) && !els.userMenu.contains(e.target)) {
                userMenuOpen = false;
                els.userMenu.classList.add('hidden');
            }
        });

        window.copyTripLink = () => {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert("Trip Link Copied!");
            });
        };

        window.downloadTripData = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tripData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "trip_data_" + tripId + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        // Listeners for inputs
        document.getElementById('create-trip-btn').onclick = async () => {
            const newId = doc(collection(db, "trips")).id;
            window.history.pushState({}, '', `?token=${newId}`);
            tripId = newId;
            addToRecentTrips(newId, 'New Trip');
            attemptAutoJoin();
        };
        document.getElementById('login-btn').onclick = () => joinTrip(els.nameIn.value);
        els.nameIn.onkeypress = (e) => { if (e.key === 'Enter') joinTrip(els.nameIn.value); };

        Object.keys(els.tabs).forEach(k => els.tabs[k].onclick = () => setTab(k));

        // Improvements: Autocomplete
        let debounceTimer;
        const suggestionBox = document.getElementById('suggestions-list');
        const destInput = document.getElementById('dest-input');

        destInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value;
            if (query.length < 3) {
                suggestionBox.classList.add('hidden');
                return;
            }
            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        suggestionBox.innerHTML = data.slice(0, 5).map(place => `
                            <div class="p-3 hover:bg-white/10 cursor-pointer text-xs border-b border-white/5 last:border-0" 
                                 onclick="selectLocation('${place.display_name.replace(/'/g, "\\'")}', ${place.lat}, ${place.lon})">
                                <div class="font-bold text-gray-200">${place.display_name.split(',')[0]}</div>
                                <div class="text-gray-500 truncate">${place.display_name}</div>
                            </div>
                        `).join('');
                        suggestionBox.classList.remove('hidden');
                    }
                } catch (e) { }
            }, 300);
        });

        // Hide suggestions on outside click
        document.addEventListener('click', (e) => {
            if (!destInput.contains(e.target) && !suggestionBox.contains(e.target)) {
                suggestionBox.classList.add('hidden');
            }
        });

        window.selectLocation = (fullName, lat, lon) => {
            const shortName = fullName.split(',')[0];
            if (!tripData.locations.find(l => l.name === shortName)) {
                tripData.locations.push({
                    id: Date.now(),
                    name: shortName, // Display name
                    fullName: fullName, // Store full for context if needed
                    coords: { lat: parseFloat(lat), lon: parseFloat(lon) },
                    votes: [currentUser.id]
                });
                sync();
            }
            destInput.value = '';
            suggestionBox.classList.add('hidden');
        };

        document.getElementById('dur-input').onchange = (e) => { tripData.duration = e.target.value; sync(); };
        document.getElementById('add-exp-btn').onclick = () => {
            const d = document.getElementById('exp-desc'), a = document.getElementById('exp-amt');
            if (d.value && a.value) {
                tripData.expenses.push({ who: currentUser.name, what: d.value, amt: a.value, id: Date.now() });
                sync(); d.value = ''; a.value = '';
            }
        };
        document.getElementById('add-pack-btn').onclick = () => {
            const p = document.getElementById('pack-input');
            if (p.value.trim()) {
                tripData.packing.push({ id: Date.now(), text: p.value.trim(), checked: false });
                sync(); p.value = '';
            }
        };

        window.toggleVote = (id) => {
            const l = tripData.locations.find(x => x.id === id);
            if (!l) return;
            if (l.votes.includes(currentUser.id)) l.votes = l.votes.filter(v => v !== currentUser.id);
            else l.votes.push(currentUser.id);
            sync();
        };
        window.togglePackItem = (id) => {
            tripData.packing = tripData.packing.map(i => i.id === id ? { ...i, checked: !i.checked } : i);
            sync();
        };

        function initCalendar() {
            const cal = document.getElementById('calendar-grid'); cal.innerHTML = '';

            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('calendar-header').innerText = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;

            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
                cal.innerHTML += `<div class="text-center text-[9px] font-bold text-gray-600 pb-1">${d}</div>`;
            });
            const today = new Date();
            for (let i = 0; i < 35; i++) {
                const d = new Date(); d.setDate(today.getDate() + i);
                const ds = d.toISOString().split('T')[0];
                const btn = document.createElement('button');
                btn.className = "day-cell h-8 rounded-lg flex flex-col items-center justify-center text-[10px] bg-black/20 border border-white/5 text-gray-500 transition-all";
                btn.dataset.date = ds;
                const isFirst = d.getDate() === 1 || i === 0;
                const label = isFirst ? d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : d.getDate();

                btn.innerHTML = `<span class="pointer-events-none ${isFirst ? 'font-bold text-[9px]' : ''}">${label}</span>`;
                btn.onclick = (e) => {
                    if (!tripData.users[currentUser.id]) {
                        // Safety recovery
                        tripData.users[currentUser.id] = { name: currentUser.name, dates: [] };
                    }
                    const u = tripData.users[currentUser.id];
                    let newDates = [...u.dates];

                    if (e.shiftKey && lastClickedDate) {
                        // Range selection
                        const d1 = new Date(lastClickedDate);
                        const d2 = new Date(ds);
                        const start = d1 < d2 ? d1 : d2;
                        const end = d1 < d2 ? d2 : d1;

                        // Add all dates in range
                        for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
                            const dateStr = dt.toISOString().split('T')[0];
                            if (!newDates.includes(dateStr)) newDates.push(dateStr);
                        }
                    } else {
                        // Toggle single
                        if (newDates.includes(ds)) newDates = newDates.filter(x => x !== ds);
                        else newDates.push(ds);
                    }

                    lastClickedDate = ds;
                    u.dates = newDates;

                    // Also clear weather cache to force refresh with new dates
                    if (tripData.locations) tripData.locations.forEach(l => { l._weather = null; l._fetching = false; });
                    sync();
                };
                cal.appendChild(btn);
            }
        }

        let lastClickedDate = null;

        function renderCalendar() {
            const counts = {}; let max = 0;
            Object.values(tripData.users).forEach(u => u.dates?.forEach(d => { counts[d] = (counts[d] || 0) + 1; max = Math.max(max, counts[d]); }));
            document.querySelectorAll('.day-cell').forEach(c => {
                const d = c.dataset.date;
                const my = tripData.users[currentUser.id]?.dates.includes(d);
                const count = counts[d] || 0;

                // Tooltip logic
                const who = Object.values(tripData.users)
                    .filter(u => u.dates && u.dates.includes(d))
                    .map(u => u.name)
                    .join(', ');
                c.title = who ? `Available: ${who}` : 'No one available';

                let cls = "day-cell h-9 rounded-lg flex flex-col items-center justify-center text-[10px] transition-all border ";
                if (my) cls += "bg-green-600/20 border-green-500/50 text-green-300 ";
                else cls += "bg-black/20 border-white/5 text-gray-500 ";

                if (count > 0) {
                    if (count === max && max > 1) {
                        // BEST DATE HIGHLIGHT (User requested "more clear")
                        cls = "day-cell h-9 rounded-lg flex flex-col items-center justify-center text-[10px] transition-all border bg-amber-500 text-black font-black shadow-[0_0_15px_rgba(245,158,11,0.6)] scale-110 z-20 ring-2 ring-white";
                    } else if (!my) {
                        // Stronger highlight for others
                        cls += "bg-blue-600/20 border-blue-400 text-blue-100 font-bold shadow-[0_0_5px_-2px_rgba(59,130,246,0.5)] ";
                    }
                }
                c.className = cls;
            });
            document.getElementById('best-dates').innerHTML = max > 1 ? `<span class="text-amber-400 text-shadow-sm">üî• Best Date found! (${max} friends)</span>` : "Select dates to match!";
        }

        // --- ITINERARY LOGIC ---

        window.createItineraryFromBest = () => {
            // Find best sequence of dates
            const counts = {};
            let maxVotes = 0;

            // Generate Vote Counts
            Object.values(tripData.users).forEach(u => u.dates?.forEach(d => {
                counts[d] = (counts[d] || 0) + 1;
                maxVotes = Math.max(maxVotes, counts[d]);
            }));

            if (maxVotes < 2) {
                alert("Need more votes to determine best dates!");
                return;
            }

            // Find all dates with maxVotes
            const bestDates = Object.keys(counts).filter(d => counts[d] === maxVotes).sort();

            // Initialize itinerary structure
            if (!tripData.itinerary) tripData.itinerary = {};

            // Add dates if not exist
            bestDates.forEach(date => {
                if (!tripData.itinerary[date]) tripData.itinerary[date] = [];
            });

            sync();
            renderItinerary();
        };

        function renderItinerary() {
            const itin = tripData.itinerary || {};
            const dates = Object.keys(itin).sort();

            if (dates.length === 0) {
                document.getElementById('itin-empty-state').classList.remove('hidden');
                document.getElementById('itin-content').innerHTML = '';
                return;
            }

            document.getElementById('itin-empty-state').classList.add('hidden');

            const html = dates.map(date => {
                const dayEvents = itin[date] || [];
                dayEvents.sort((a, b) => a.time.localeCompare(b.time));

                const dObj = new Date(date);
                const dayName = dObj.toLocaleDateString('en-US', { weekday: 'long' });
                const datePretty = dObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });

                return `
                <div class="bg-gray-800/30 border border-white/5 rounded-2xl overflow-hidden backdrop-blur-sm">
                    <div class="bg-white/5 p-3 flex justify-between items-center border-b border-white/5">
                        <div>
                            <span class="block text-xs font-bold text-amber-500 uppercase tracking-widest">${dayName}</span>
                            <span class="block text-lg font-bold text-white">${datePretty}</span>
                        </div>
                        <button onclick="openItinModal('${date}')" class="w-8 h-8 rounded-lg bg-black/20 hover:bg-amber-500/20 text-gray-400 hover:text-amber-400 flex items-center justify-center transition-colors text-lg font-bold">+</button>
                    </div>
                    <div class="p-2 space-y-2">
                        ${dayEvents.length === 0 ? '<div class="text-center text-xs text-gray-600 py-4 italic">No events planned</div>' : ''}
                        ${dayEvents.map(e => `
                            <div onclick="openItinModal('${date}', '${e.id}')" class="flex gap-4 p-3 rounded-xl bg-black/20 border border-white/5 hover:border-amber-500/30 hover:bg-white/5 cursor-pointer transition-all group">
                                <div class="flex flex-col items-center justify-center w-12 border-r border-white/10 pr-4">
                                    <span class="text-sm font-bold text-gray-200">${e.time}</span>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-200 text-sm group-hover:text-amber-200">${e.title}</h4>
                                    ${e.cost ? `<span class="text-[10px] text-green-400 font-mono">Est: ‚Ç¨${e.cost}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }).join('');

            document.getElementById('itin-content').innerHTML = html;
        }

        // Modal Logic
        let editingDate = null;
        let editingId = null;

        window.openItinModal = (date, id = null) => {
            editingDate = date;
            editingId = id;
            const modal = document.getElementById('itin-modal');
            const title = document.getElementById('itin-title-input');
            const time = document.getElementById('itin-time-input');
            const cost = document.getElementById('itin-cost-input');
            const delBtn = document.getElementById('itin-delete-btn');

            document.getElementById('itin-modal-date').innerText = date;

            if (id) {
                const item = tripData.itinerary[date].find(i => i.id == id);
                document.getElementById('itin-modal-title').innerText = "Edit Event";
                title.value = item.title;
                time.value = item.time;
                cost.value = item.cost || '';
                delBtn.classList.remove('hidden');
            } else {
                document.getElementById('itin-modal-title').innerText = "New Event";
                title.value = '';
                time.value = "12:00";
                cost.value = '';
                delBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            title.focus();
        };

        window.closeItinModal = () => {
            document.getElementById('itin-modal').classList.add('hidden');
        };

        window.saveItinEvent = () => {
            const title = document.getElementById('itin-title-input').value;
            const time = document.getElementById('itin-time-input').value;
            const cost = document.getElementById('itin-cost-input').value;

            if (!title || !time) return; // Simple validation

            if (!tripData.itinerary) tripData.itinerary = {};
            if (!tripData.itinerary[editingDate]) tripData.itinerary[editingDate] = [];

            if (editingId) {
                // Edit
                const idx = tripData.itinerary[editingDate].findIndex(i => i.id == editingId);
                if (idx > -1) {
                    tripData.itinerary[editingDate][idx] = {
                        ...tripData.itinerary[editingDate][idx],
                        title, time, cost
                    };
                }
            } else {
                // Create
                tripData.itinerary[editingDate].push({
                    id: Date.now(),
                    title, time, cost
                });
            }

            // Check if cost needs to be added to Expenses tab? 
            // For now, keep separate as requested ("Estimate").

            sync();
            closeItinModal();
            renderItinerary();
        };

        window.deleteItinEvent = () => {
            if (editingDate && editingId && tripData.itinerary[editingDate]) {
                tripData.itinerary[editingDate] = tripData.itinerary[editingDate].filter(i => i.id != editingId);
                sync();
                closeItinModal();
                renderItinerary();
            }
        };
        window.toggleWeather = () => {
            const c = document.getElementById('weather-content');
            c.classList.toggle('hidden');
        };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err));
            });
        }

        init();
    </script>
    </body>

</html>