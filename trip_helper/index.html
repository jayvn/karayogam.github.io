<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }

        .day-cell {
            transition: all 0.2s;
            position: relative;
        }

        .day-cell:active {
            transform: scale(0.95);
        }

        /* Dark mode best date: Dark Amber bg + Purple border */
        .best-date {
            background-color: #451a03 !important;
            border-color: #c084fc !important;
            border-width: 2px !important;
            color: #fbbf24 !important;
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- LANDING SCREEN (No Token) -->
    <div id="landing-screen"
        class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center p-6 hidden">
        <h1 class="text-6xl mb-4">‚úàÔ∏è</h1>
        <h2 class="text-3xl font-bold mb-8 text-blue-400">Trip Planner</h2>

        <button id="create-trip-btn"
            class="w-full max-w-xs bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl text-lg shadow-lg mb-8 transform transition hover:scale-105">
            + Start New Trip
        </button>

        <div id="recent-trips-container" class="w-full max-w-xs hidden">
            <h3 class="text-gray-500 text-sm font-bold uppercase tracking-wider mb-2">Recent Trips</h3>
            <div id="recent-trips-list" class="space-y-2"></div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center p-6 hidden">
        <h1 class="text-4xl mb-2">üëã</h1>
        <h2 class="text-2xl font-bold mb-6 text-gray-200">Who are you?</h2>

        <div id="new-user-form" class="w-full max-w-xs">
            <input type="text" id="username-input"
                class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg mb-4 text-lg text-white outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500"
                placeholder="Enter your name">
            <button id="login-btn"
                class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">Join
                Trip</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="flex-1 flex flex-col hidden max-w-2xl mx-auto w-full bg-gray-900 shadow-xl h-full">

        <!-- HEADER -->
        <header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center z-10 shrink-0">
            <div class="flex items-center gap-2 cursor-pointer" onclick="copyTripLink()">
                <div>
                    <h1 class="font-bold text-lg text-white leading-tight">Trip Planner</h1>
                    <p class="text-[10px] text-green-400 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Online
                    </p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="switchTrip()"
                    class="bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs py-1 px-3 rounded border border-gray-600">
                    ‚úàÔ∏è Switch Trip
                </button>
                <button id="user-display" onclick="logout()"
                    class="bg-gray-700 hover:bg-gray-600 text-blue-300 text-xs py-1 px-3 rounded border border-gray-600 font-bold">
                    User
                </button>
            </div>
        </header>

        <!-- TABS -->
        <div class="flex border-b border-gray-700 bg-gray-800 overflow-x-auto">
            <button id="tab-plan"
                class="flex-1 p-3 text-center font-bold text-blue-400 border-b-2 border-blue-400 whitespace-nowrap">üìÖ
                Planning</button>
            <button id="tab-vote"
                class="flex-1 p-3 text-center font-bold text-gray-400 hover:bg-gray-700 whitespace-nowrap">üìç
                Location</button>
            <button id="tab-exp"
                class="flex-1 p-3 text-center font-bold text-gray-400 hover:bg-gray-700 whitespace-nowrap">üí∏
                Expenses</button>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4">

            <!-- TAB: PLANNING -->
            <div id="view-plan">
                <!-- DESTINATION STATUS -->
                <section
                    class="bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-sm mb-4 flex justify-between items-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-900/10 to-transparent pointer-events-none">
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-500 text-xs uppercase tracking-wider">Destination</h3>
                        <div id="plan-dest-display" class="text-2xl font-black text-gray-500 mt-1">&lt;Pending&gt;</div>
                    </div>
                    <div id="plan-weather-icon" class="text-4xl hidden filter drop-shadow-md"></div>
                </section>

                <!-- MEMBERS -->
                <section class="bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-sm mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-500 text-xs uppercase tracking-wider">üë• Members</h3>
                        <button onclick="copyTripLink()"
                            class="text-[10px] bg-blue-900/50 text-blue-300 px-2 py-1 rounded border border-blue-800 hover:bg-blue-800">üîó
                            Invite</button>
                    </div>
                    <div id="member-list" class="flex flex-wrap gap-2"></div>
                </section>

                <!-- CALENDAR -->
                <section class="bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-sm mb-4">
                    <div class="flex flex-col mb-4">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="font-bold text-gray-500 text-xs uppercase tracking-wider">üìÖ Availability</h3>
                            <div class="text-[10px] text-gray-400">Next 35 Days</div>
                        </div>
                        <div class="flex flex-wrap gap-3 text-[10px] text-gray-400 bg-gray-900/50 p-2 rounded">
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 bg-green-600 rounded"></div> You
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 border-2 border-blue-500 rounded"></div> Others
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="w-3 h-3 bg-[#451a03] border-2 border-purple-400 rounded"></div> Best Match
                            </div>
                        </div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 select-none"></div>
                    <div id="best-dates" class="mt-3 text-sm text-purple-400 font-bold min-h-[1.5em]"></div>
                </section>

                <!-- PACKING LIST -->
                <section class="bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-sm mb-4">
                    <h3 class="font-bold text-gray-500 text-xs uppercase mb-3 tracking-wider">üéí Shared Packing List
                    </h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="pack-input" placeholder="Add item..."
                            class="flex-1 p-3 bg-gray-900 border border-gray-700 rounded text-sm text-white placeholder-gray-600 focus:border-blue-500 outline-none">
                        <button id="add-pack-btn"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded font-bold text-lg">+</button>
                    </div>
                    <div id="packing-list" class="space-y-2 text-sm"></div>
                </section>
            </div>

            <!-- TAB: DESTINATIONS -->
            <div id="view-vote" class="hidden">
                <section class="bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-sm mb-4">
                    <div class="flex items-center gap-3 text-sm border-b border-gray-700 pb-4 mb-4 text-gray-300">
                        <span class="text-gray-500 font-bold uppercase text-xs">Trip Duration:</span>
                        <input type="number" id="dur-input"
                            class="w-16 p-2 bg-gray-900 border border-gray-700 rounded text-center text-white font-bold"
                            placeholder="#" min="1">
                        <span class="text-gray-500">days</span>
                    </div>

                    <h3 class="font-bold text-gray-500 text-xs uppercase mb-3 tracking-wider">üìç Vote Location</h3>

                    <div class="flex gap-2 mb-4">
                        <input type="text" id="dest-input"
                            class="flex-1 p-3 bg-gray-900 border border-gray-700 rounded text-sm text-white placeholder-gray-600 focus:border-blue-500 outline-none"
                            placeholder="City, Country...">
                        <button id="suggest-btn"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded text-sm font-bold">Add</button>
                    </div>

                    <div id="location-list" class="space-y-3 mb-4"></div>

                    <!-- Weather Widget -->
                    <div id="weather-widget" class="hidden mt-6 bg-gray-900/50 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleWeather()">
                            <h4 class="text-xs font-bold text-gray-400">üå§Ô∏è LEADING OPTION FORECAST</h4>
                            <span id="weather-toggle-icon" class="text-xs text-blue-400">Expand</span>
                        </div>
                        <div id="weather-content" class="hidden">
                            <div id="weather-loading" class="text-center text-xs text-gray-500 py-2 hidden">Loading
                                weather...</div>
                            <div id="weather-row"
                                class="flex justify-between text-center text-sm gap-1 text-gray-300 overflow-x-auto pb-2">
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- TAB: EXPENSES -->
            <div id="view-exp" class="hidden">
                <section class="bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-sm pb-10">
                    <div class="flex justify-between items-center mb-4 bg-gray-900/50 p-3 rounded">
                        <h3 class="font-bold text-gray-500 text-xs uppercase tracking-wider">üí∏ Expenses</h3>
                        <span id="exp-total" class="text-sm font-bold text-green-400">Total: $0</span>
                    </div>
                    <div class="flex flex-col gap-2 mb-4 border-b border-gray-700 pb-4">
                        <input type="text" id="exp-desc" placeholder="What did you pay for?"
                            class="w-full p-3 bg-gray-900 border border-gray-700 rounded text-sm text-white placeholder-gray-600 focus:border-blue-500 outline-none">
                        <div class="flex gap-2">
                            <input type="number" id="exp-amt" placeholder="$0.00"
                                class="w-full p-3 bg-gray-900 border border-gray-700 rounded text-sm text-white placeholder-gray-600 focus:border-blue-500 outline-none">
                            <button id="add-exp-btn"
                                class="bg-green-600 hover:bg-green-500 text-white px-6 rounded font-bold">Add</button>
                        </div>
                    </div>
                    <div id="expense-list" class="space-y-3 text-sm"></div>
                </section>
            </div>

        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyATX9AewOd8pmUQWkYXYAvb2meH7kGNtbg",
            authDomain: "karayogam-22.firebaseapp.com",
            projectId: "karayogam-22",
            storageBucket: "karayogam-22.firebasestorage.app",
            messagingSenderId: "38360726672",
            appId: "1:38360726672:web:d254e8eed733ddf3c9ac15"
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = { id: null, name: null };
        let tripId = null;
        let tripData = {
            locations: [],
            duration: '',
            users: {},
            expenses: [],
            packing: [],
            createdAt: Date.now()
        };
        let lastWeatherCoords = null;
        let currentTab = 'plan';
        let weatherExpanded = false;
        let unsubscribe = null;

        // Elements
        const els = {
            landing: document.getElementById('landing-screen'),
            createTripBtn: document.getElementById('create-trip-btn'),
            recentTripsCont: document.getElementById('recent-trips-container'),
            recentTripsList: document.getElementById('recent-trips-list'),

            login: document.getElementById('login-screen'),
            nameIn: document.getElementById('username-input'),
            loginBtn: document.getElementById('login-btn'),

            app: document.getElementById('app-screen'),
            userDisplay: document.getElementById('user-display'),

            tabPlan: document.getElementById('tab-plan'),
            tabVote: document.getElementById('tab-vote'),
            tabExp: document.getElementById('tab-exp'),
            viewPlan: document.getElementById('view-plan'),
            viewVote: document.getElementById('view-vote'),
            viewExp: document.getElementById('view-exp'),

            planDestDisplay: document.getElementById('plan-dest-display'),
            planWeatherIcon: document.getElementById('plan-weather-icon'),
            memberList: document.getElementById('member-list'),
            cal: document.getElementById('calendar-grid'),
            bestDates: document.getElementById('best-dates'),
            packIn: document.getElementById('pack-input'),
            packBtn: document.getElementById('add-pack-btn'),
            packList: document.getElementById('packing-list'),

            destIn: document.getElementById('dest-input'),
            durIn: document.getElementById('dur-input'),
            suggestBtn: document.getElementById('suggest-btn'),
            locList: document.getElementById('location-list'),
            weatherWidget: document.getElementById('weather-widget'),
            weatherContent: document.getElementById('weather-content'),
            weatherToggle: document.getElementById('weather-toggle-icon'),
            weatherRow: document.getElementById('weather-row'),
            weatherLoading: document.getElementById('weather-loading'),

            expDesc: document.getElementById('exp-desc'),
            expAmt: document.getElementById('exp-amt'),
            expBtn: document.getElementById('add-exp-btn'),
            expList: document.getElementById('expense-list'),
            expTotal: document.getElementById('exp-total'),
        };

        // --- AUTH & INIT ---
        async function init() {
            // 1. Check URL for Token
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            // 2. Auth Firebase
            await signInAnonymously(auth);

            if (token) {
                tripId = token;
                await attemptAutoJoin();
            } else {
                showLanding();
            }
        }

        async function attemptAutoJoin() {
            // Check if we have a saved name
            const savedName = localStorage.getItem('trip_user_name');
            if (savedName) {
                await joinTrip(savedName);
            } else {
                showLogin();
            }
        }

        function showLanding() {
            els.landing.classList.remove('hidden');
            els.login.classList.add('hidden');
            els.app.classList.add('hidden');

            renderRecentTrips();
        }

        function renderRecentTrips() {
            const recent = JSON.parse(localStorage.getItem('my_trips') || '[]');
            if (recent.length === 0) {
                els.recentTripsCont.classList.add('hidden');
                return;
            }
            els.recentTripsCont.classList.remove('hidden');
            els.recentTripsList.innerHTML = recent.map(t => `
                <div onclick="window.location.href='?token=${t.id}'" class="p-3 bg-gray-800 rounded-lg border border-gray-700 hover:bg-gray-700 cursor-pointer flex justify-between items-center transition">
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-200">${t.name || 'Untitled Trip'}</span>
                        <span class="text-[10px] text-gray-500">ID: ${t.id.slice(0, 6)}...</span>
                    </div>
                    <span class="text-blue-400">‚ûú</span>
                </div>
            `).join('');
        }

        function showLogin() {
            els.landing.classList.add('hidden');
            els.login.classList.remove('hidden');
            els.app.classList.add('hidden');
            els.nameIn.value = '';
            els.nameIn.focus();
        }

        // Button Listeners
        els.createTripBtn.onclick = async () => {
            const newId = doc(collection(db, "trips")).id; // Generate ID
            const newTrip = { ...tripData };
            // Redirect will handle the rest
            window.history.pushState({}, '', `?token=${newId}`);
            tripId = newId;
            // Add to recent immediately
            addToRecentTrips(newId, 'New Trip');
            await attemptAutoJoin();
        };

        els.loginBtn.onclick = () => {
            const name = els.nameIn.value.trim();
            if (name) joinTrip(name);
        };

        // Also handle enter key on login
        els.nameIn.onkeypress = (e) => {
            if (e.key === 'Enter') els.loginBtn.click();
        };

        // --- TRIP LOGIC ---
        async function joinTrip(name) {
            currentUser.name = name;
            currentUser.id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');

            // Persist user preference
            localStorage.setItem('trip_user_name', name);

            // Connect to Firebase
            setupRealtimeListener();

            // Show App
            els.login.classList.add('hidden');
            els.landing.classList.add('hidden');
            els.app.classList.remove('hidden');
            els.userDisplay.innerText = name;

            initCalendar();
            setTab('plan');

            // Add ID to recent trips if not there, we will update name when data loads
            addToRecentTrips(tripId, 'Loading...');
        }

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();
            const docRef = doc(db, 'trips', tripId);

            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    tripData = docSnap.data();
                    // Ensure current user is in participants list if not already
                    if (!tripData.users) tripData.users = {};
                    if (!tripData.users[currentUser.id]) {
                        // We don't write immediately to avoid race loops, we wait for user action or just render
                        // Actually, we should register them now
                        registerUserInTrip();
                    }
                    // Update Trip Name in Recent List based on top Location
                    updateRecentTripName();
                    render();
                } else {
                    // New Trip! Initialize it.
                    tripData.users = {};
                    tripData.users[currentUser.id] = { name: currentUser.name, dates: [] };
                    setDoc(docRef, tripData);
                }
            });
        }

        function registerUserInTrip() {
            if (!tripData.users[currentUser.id]) {
                tripData.users[currentUser.id] = { name: currentUser.name, dates: [] };
                sync();
            }
        }

        function sync() {
            const docRef = doc(db, 'trips', tripId);
            setDoc(docRef, tripData, { merge: true });
        }

        // --- RECENT TRIPS UTIL ---
        function addToRecentTrips(id, name) {
            let recent = JSON.parse(localStorage.getItem('my_trips') || '[]');
            // Remove if exists
            recent = recent.filter(t => t.id !== id);
            // Add to top
            recent.unshift({ id, name });
            // Max 5
            if (recent.length > 5) recent.pop();
            localStorage.setItem('my_trips', JSON.stringify(recent));
        }

        function updateRecentTripName() {
            let name = 'Untitled Trip';
            // Name trip after top location
            const locs = tripData.locations || [];
            if (locs.length > 0) {
                const best = locs.sort((a, b) => b.votes.length - a.votes.length)[0];
                name = `Trip to ${best.name}`;
            }
            addToRecentTrips(tripId, name);
        }

        // --- TAB LOGIC ---
        function setTab(tab) {
            currentTab = tab;
            [els.tabPlan, els.tabVote, els.tabExp].forEach(el => {
                el.className = "flex-1 p-3 text-center font-bold text-gray-500 hover:bg-gray-700 whitespace-nowrap transition-colors";
            });
            [els.viewPlan, els.viewVote, els.viewExp].forEach(el => el.classList.add('hidden'));

            const activeClass = "flex-1 p-3 text-center font-bold text-blue-400 border-b-2 border-blue-400 whitespace-nowrap bg-gray-800/50";
            if (tab === 'plan') {
                els.tabPlan.className = activeClass;
                els.viewPlan.classList.remove('hidden');
            } else if (tab === 'vote') {
                els.tabVote.className = activeClass;
                els.viewVote.classList.remove('hidden');
            } else if (tab === 'exp') {
                els.tabExp.className = activeClass;
                els.viewExp.classList.remove('hidden');
            }
            render();
        }
        els.tabPlan.onclick = () => setTab('plan');
        els.tabVote.onclick = () => setTab('vote');
        els.tabExp.onclick = () => setTab('exp');

        // --- RENDER & LOGIC ---
        function render() {
            if (!tripData) return;

            const sortedLocs = [...(tripData.locations || [])].sort((a, b) => b.votes.length - a.votes.length);
            const topLocation = sortedLocs[0];

            // 1. Members
            els.memberList.innerHTML = Object.values(tripData.users).map(u => `
                <div class="px-3 py-1 bg-gray-700 rounded-full text-xs text-gray-200 border border-gray-600 flex items-center gap-1">
                    <span class="font-bold">${u.name}</span>
                </div>
            `).join('');

            // 2. Plan Tab Logic
            if (currentTab === 'plan') {
                if (topLocation && topLocation.votes.length > 0) {
                    els.planDestDisplay.innerText = topLocation.name;
                    els.planDestDisplay.className = "text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 mt-1";
                    els.planWeatherIcon.innerText = getIconForWeatherSafe(topLocation.weatherCode);
                    // Note: We might need to fetch weather if not stored. For now, rely on widget.
                    // Actually, simple icon based on widget logic? 
                    // Let's just keep it hidden until widget fetches it or implement specific logic.
                    // Simplified: Show icon if we have weather in view-vote? No, cleaner to not show if not ready.
                    els.planWeatherIcon.classList.remove('hidden');
                } else {
                    els.planDestDisplay.innerText = "<Vote Location>";
                    els.planDestDisplay.className = "text-2xl font-black text-gray-600 mt-1";
                    els.planWeatherIcon.classList.add('hidden');
                }
                renderCalendar();
                // Packing
                els.packList.innerHTML = (tripData.packing || []).map(item => `
                    <div class="flex items-center p-3 bg-gray-900 rounded-lg border border-gray-800 hover:border-gray-600 cursor-pointer transition" 
                         onclick="window.togglePackItem(${item.id})">
                        <span class="mr-3 text-lg">${item.checked ? '‚úÖ' : '‚¨ú'}</span>
                        <span class="${item.checked ? 'line-through text-gray-500' : 'text-gray-200 font-medium'}">${item.text}</span>
                    </div>
                `).join('');
            }

            // 3. Vote Tab Logic
            if (currentTab === 'vote') {
                if (document.activeElement !== els.durIn) els.durIn.value = tripData.duration || '';

                els.locList.innerHTML = sortedLocs.map(loc => {
                    const hasVoted = loc.votes.includes(currentUser.id);
                    return `
                    <div class="relative overflow-hidden flex justify-between items-center p-3 bg-gray-900 rounded-lg border ${hasVoted ? 'border-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.2)]' : 'border-gray-700'}">
                         <div class="absolute inset-0 bg-blue-600/5 ${hasVoted ? 'opacity-100' : 'opacity-0'}"></div>
                        <div class="relative flex-1">
                            <div class="font-bold text-base text-gray-100">${loc.name}</div>
                            <div class="text-[10px] text-gray-400 uppercase tracking-wider">${loc.votes.length} Votes</div>
                        </div>
                        <button onclick="window.toggleVote(${loc.id})" 
                            class="relative z-10 px-4 py-2 rounded text-xs font-bold uppercase transition-all ${hasVoted ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-gray-800 border border-gray-600 text-gray-400 hover:bg-gray-700 hover:text-gray-200'}">
                            ${hasVoted ? 'Voted' : 'Vote'}
                        </button>
                    </div>
                `}).join('');

                if (sortedLocs.length > 0) {
                    const winner = sortedLocs[0];
                    const { lat, lon } = winner.coords;
                    if (!lastWeatherCoords || lastWeatherCoords.lat !== lat || lastWeatherCoords.lon !== lon) {
                        lastWeatherCoords = { lat, lon };
                        fetchWeather(lat, lon);
                    }
                    els.weatherWidget.classList.remove('hidden');
                } else {
                    els.weatherWidget.classList.add('hidden');
                }
            }

            // 4. Expenses Tab Logic
            if (currentTab === 'exp') {
                const total = (tripData.expenses || []).reduce((sum, e) => sum + parseFloat(e.amt), 0);
                els.expTotal.innerText = `Total: $${total.toFixed(2)}`;
                els.expList.innerHTML = (tripData.expenses || []).slice().reverse().map(e => `
                    <div class="flex justify-between items-center bg-gray-900 p-3 rounded-lg border border-gray-800">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-200">${e.what}</span>
                            <span class="text-xs text-gray-500">paid by <span class="text-blue-400">${e.who}</span></span>
                        </div>
                        <div class="font-mono font-bold text-green-400 text-lg">$${parseFloat(e.amt).toFixed(2)}</div>
                    </div>
                `).join('');
            }
        }

        function getIconForWeatherSafe(code) {
            // simplified placeholder
            return 'üå§Ô∏è';
        }

        // --- ACTIONS ---
        window.switchTrip = () => {
            window.location.href = window.location.pathname;
        };

        window.logout = () => {
            localStorage.removeItem('trip_user_name');
            location.reload();
        };

        window.copyTripLink = () => {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert("Trip Link Copied! Send it to your friends.");
            });
        };

        els.suggestBtn.onclick = async () => {
            const query = els.destIn.value;
            if (!query) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data && data.length > 0) {
                    const name = data[0].display_name.split(',')[0];
                    if (!tripData.locations.find(l => l.name === name)) {
                        tripData.locations.push({
                            id: Date.now(), name: name, coords: { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) }, votes: [currentUser.id]
                        });
                        sync();
                    }
                }
            } catch (e) { console.error(e); }
            els.destIn.value = '';
        };

        els.durIn.onchange = (e) => { tripData.duration = e.target.value; sync(); };
        els.expBtn.onclick = () => {
            const desc = els.expDesc.value; const amt = parseFloat(els.expAmt.value);
            if (!desc || isNaN(amt)) return;
            tripData.expenses.push({ who: currentUser.name, what: desc, amt: amt, id: Date.now() });
            sync();
            els.expDesc.value = ''; els.expAmt.value = '';
        };
        els.packBtn.onclick = () => {
            const item = els.packIn.value.trim();
            if (!item) return;
            tripData.packing.push({ id: Date.now(), text: item, checked: false });
            sync();
            els.packIn.value = '';
        };

        window.toggleVote = (locId) => {
            const loc = tripData.locations.find(l => l.id === locId);
            if (!loc) return;
            if (loc.votes.includes(currentUser.id)) loc.votes = loc.votes.filter(v => v !== currentUser.id);
            else loc.votes.push(currentUser.id);
            sync();
        };

        window.togglePackItem = (itemId) => {
            tripData.packing = tripData.packing.map(i => i.id === itemId ? { ...i, checked: !i.checked } : i);
            sync();
        };

        // --- WEATHER ---
        window.toggleWeather = () => {
            weatherExpanded = !weatherExpanded;
            els.weatherContent.classList.toggle('hidden', !weatherExpanded);
            els.weatherToggle.innerText = weatherExpanded ? 'Collapse' : 'Expand';
        };

        async function fetchWeather(lat, lon) {
            els.weatherLoading.classList.remove('hidden');
            els.weatherRow.innerHTML = '';
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`);
                const data = await res.json();
                els.weatherLoading.classList.add('hidden');
                els.weatherRow.innerHTML = data.daily.time.slice(0, 5).map((t, i) => {
                    const code = data.daily.weathercode[i];
                    let icon = '‚òÄÔ∏è';
                    if (code > 2) icon = '‚õÖ'; if (code > 40) icon = 'üå´Ô∏è'; if (code > 50) icon = 'üåßÔ∏è'; if (code > 70) icon = 'üå®Ô∏è'; if (code > 90) icon = '‚õàÔ∏è';
                    const date = new Date(t).toLocaleDateString('en-US', { weekday: 'short' });
                    return `
                    <div class="flex flex-col items-center min-w-[3rem] p-2 bg-gray-800 rounded">
                        <span class="text-[10px] font-bold text-gray-400 uppercase">${date}</span>
                        <span class="text-2xl my-1">${icon}</span>
                        <span class="text-xs font-bold text-gray-200">${Math.round(data.daily.temperature_2m_max[i])}¬∞</span>
                    </div>`;
                }).join('');
            } catch (e) {
                els.weatherLoading.innerText = 'Weather error';
            }
        }

        // --- CALENDAR ---
        function initCalendar() {
            els.cal.innerHTML = '';
            const today = new Date();
            const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            days.forEach(d => {
                const el = document.createElement('div'); el.className = "text-center text-[10px] font-bold text-gray-600 pb-1"; el.innerText = d; els.cal.appendChild(el);
            });
            for (let i = 0; i < 35; i++) {
                const d = new Date(); d.setDate(today.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const btn = document.createElement('button');
                btn.className = "day-cell h-8 rounded flex flex-col items-center justify-center text-[10px] bg-gray-900 border border-gray-800 text-gray-600 transition-colors";
                btn.dataset.date = dateStr;
                btn.innerHTML = `<span class="pointer-events-none font-medium">${d.getDate()}</span>`;
                btn.onclick = () => toggleDate(dateStr);
                els.cal.appendChild(btn);
            }
        }

        function toggleDate(dateStr) {
            const u = tripData.users[currentUser.id];
            if (!u) return; // safety
            if (!u.dates) u.dates = [];

            if (u.dates.includes(dateStr)) u.dates = u.dates.filter(d => d !== dateStr);
            else u.dates.push(dateStr);
            sync();
        }

        function renderCalendar() {
            if (!tripData.users) return;
            // 1. Calculate stats
            const dateCounts = {};
            let maxOverlap = 0;
            const namesByDate = {}; // Track who is available when

            Object.values(tripData.users).forEach(u => {
                if (u.dates?.length) {
                    u.dates.forEach(d => {
                        dateCounts[d] = (dateCounts[d] || 0) + 1;
                        if (!namesByDate[d]) namesByDate[d] = [];
                        namesByDate[d].push(u.name);
                        maxOverlap = Math.max(maxOverlap, dateCounts[d]);
                    });
                }
            });

            // 2. Render cells
            document.querySelectorAll('.day-cell').forEach(cell => {
                const date = cell.dataset.date;
                const myDates = tripData.users[currentUser.id]?.dates || [];
                const count = dateCounts[date] || 0;

                // Set tooltip
                const availableNames = namesByDate[date] ? namesByDate[date].join(', ') : 'No one';
                cell.title = `${date}\nAvailable: ${availableNames}`;

                // Base Class logic
                let classes = ["day-cell", "h-8", "rounded", "flex", "flex-col", "items-center", "justify-center", "text-[10px]", "transition-all", "border"];
                let style = "";

                if (myDates.includes(date)) {
                    classes.push("bg-green-900/40", "border-green-600/50", "text-green-300");
                } else {
                    classes.push("bg-gray-900", "border-gray-800", "text-gray-500");
                }

                // Hotspots
                if (count > 0) {
                    // Opacity based on popularity?
                    if (count === maxOverlap && maxOverlap > 1) {
                        // BEST DATE
                        classes = classes.filter(c => !c.includes('bg-') && !c.includes('border-'));
                        classes.push("best-date", "text-yellow-100", "font-black", "ring-1", "ring-yellow-500/50");
                    } else if (!myDates.includes(date)) {
                        // Popular but not mine
                        classes.push("ring-1", "ring-blue-500/30");
                    }
                }

                cell.className = classes.join(" ");
            });

            els.bestDates.innerHTML = maxOverlap > 1 ? `üî• Best Date: ${maxOverlap} people available` : "";
        }

        // Global exposure for onClick handlers
        window.toggleVote = toggleVote;
        window.togglePackItem = togglePackItem;

        // Start
        init();
    </script>
</body>

</html>